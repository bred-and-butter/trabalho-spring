<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master House Imobiliária - Administrador</title>
    <link rel="stylesheet" href="style_dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="top-bar">
            <div class="logo-area">
                <img src="MasterHouse.png" alt="Logo Master House Imobiliária" class="logo-header">
                <span class="system-name">Master House Imobiliária</span>
            </div>
            <div class="user-info">
                <span>Bem-vindo, Administrador!</span>
                <a href="login.html" class="logout-btn">Sair</a>
            </div>
        </header>

        <nav class="sidebar">
            <ul>
                <li><a href="#dashboard-section" class="sidebar-link active" data-content-id="dashboard-section"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                
                <li class="menu-divider">Gestão</li>
                <li><a href="#users-management-section" class="sidebar-link" data-content-id="users-management-section"><i class="fas fa-user-shield"></i> Usuários</a></li>
                <li><a href="#clients-management-section" class="sidebar-link" data-content-id="clients-management-section"><i class="fas fa-users"></i> Clientes</a></li>
                <li><a href="#properties-management-section" class="sidebar-link" data-content-id="properties-management-section"><i class="fas fa-building"></i> Imóveis</a></li>
                
                <li><a href="#visits-interests-management-section" class="sidebar-link" data-content-id="visits-interests-management-section"><i class="fas fa-eye"></i> Visitas e Interesses</a></li>

                <li><a href="#sales-management-section" class="sidebar-link" data-content-id="sales-management-section"><i class="fas fa-handshake"></i> Vendas</a></li>
                
                <li><a href="login.html" class="sidebar-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>

        <main class="main-content">

            <section id="dashboard-section" class="content-section active">
                <h2>Dashboard do Administrador</h2>
                <p>Visão geral e acesso a todas as funcionalidades do sistema.</p>
                <div class="dashboard-stats">
                    <a href="#list-manage-users-content" class="stat-card action-card sidebar-link" data-content-id="list-manage-users-content">
                        <h3>Total de Usuários (Funcionários)</h3>
                        <p class="stat-number" id="stat-total-users">0</p>
                    </a>
                    <a href="#list-manage-clients-content" class="stat-card action-card sidebar-link" data-content-id="list-manage-clients-content">
                        <h3>Total de Clientes</h3>
                        <p class="stat-number" id="stat-total-clients">0</p>
                    </a>
                    <a href="#list-manage-properties-content" class="stat-card action-card sidebar-link" data-content-id="list-manage-properties-content">
                        <h3>Imóveis Cadastrados</h3>
                        <p class="stat-number" id="stat-total-properties">0</p>
                    </a>
                    <a href="#track-sales-section" class="stat-card action-card sidebar-link" data-content-id="track-sales-section">
                        <h3>Vendas Concluídas</h3>
                        <p class="stat-number" id="stat-total-sales">0</p>
                    </a>
                    <a href="#consult-visits-section" class="stat-card action-card sidebar-link" data-content-id="consult-visits-section">
                        <h3>Visitas Registradas Hoje</h3>
                        <p class="stat-number" id="stat-visits-today">0</p>
                    </a>
                    <a href="#consult-visits-section" class="stat-card action-card sidebar-link" data-content-id="consult-visits-section">
                        <h3>Interesses Registrados (Últ. 7 dias)</h3>
                        <p class="stat-number" id="stat-interests-7days">0</p>
                    </a>
                </div>
            </section>

            <section id="users-management-section" class="content-section">
                <h2>Gestão de Usuários</h2>
                <p>Gerencie todos os tipos de usuários do sistema (Administradores, Gerentes e Corretores).</p>
                <div class="dashboard-stats">
                    <a href="#register-user-section" class="stat-card action-card sidebar-link" data-content-id="register-user-section">
                        <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Usuário</h3>
                        <p>Crie novas contas de Administradores, Gerentes ou Corretores.</p>
                    </a>
                    <a href="#list-manage-users-content" class="stat-card action-card sidebar-link" data-content-id="list-manage-users-content">
                        <h3><i class="fas fa-users-cog"></i> Listar e Gerenciar Usuários</h3>
                        <p>Visualize, edite, ative/inative ou exclua usuários existentes.</p>
                    </a>
                </div>
            </section>

            <section id="register-user-section" class="content-section">
                <h2 id="user-form-title">Cadastrar Novo Usuário</h2>
                <p id="user-form-description">Preencha os campos abaixo para registrar um novo usuário no sistema.</p>
                <form action="#" method="POST" class="user-form" id="user-registration-form">
                    <input type="hidden" id="user_id" name="userId">
                    <h3>Dados Pessoais</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="cpf_cnpj_select_user">Tipo de Documento:</label>
                            <select id="cpf_cnpj_select_user" name="documentType" required>
                                <option value="">Selecione</option>
                                <option value="CPF">CPF</option>
                                <option value="CNPJ">CNPJ</option>
                            </select>
                        </div>
                       <div class="form-group" id="cpf_group_user">
                            <label for="cpf_user">CPF:</label>
                            <input type="text" id="cpf_user" name="cpf" placeholder="Ex: 123.456.789-00" pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" oninput="this.value = formatCpf(this.value)">
                        </div>
                        <div class="form-group" id="cnpj_group_user" style="display: none;">
                            <label for="cnpj_user">CNPJ:</label>
                            <input type="text" id="cnpj_user" name="cnpj" placeholder="Ex: 00.000.000/0000-00" pattern="\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2}" oninput="this.value = formatCnpj(this.value)">
                        </div>
                        <div class="form-group full-width">
                            <label for="nome_user">Nome Completo:</label>
                            <input type="text" id="nome_user" name="nome" placeholder="Nome completo do usuário" required>
                        </div>
                        <div class="form-group">
                            <label for="email_user">Email:</label>
                            <input type="email" id="email_user" name="email" placeholder="email@exemplo.com" required>
                        </div>
                        <div class="form-group">
                            <label for="telefone_user">Telefone:</label>
                            <input type="tel" id="telefone_user" name="telefone" placeholder="Ex: (XX) XXXXX-XXXX" pattern="\(\d{2}\)\s\d{4,5}-\d{4}">
                        </div>
                    </div>

                    <h3>Endereço</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="cep_user">CEP:</label>
                            <input type="text" id="cep_user" name="cep" placeholder="Ex: XXXXX-XXX" pattern="\d{5}-\d{3}">
                        </div>
                        <div class="form-group">
                            <label for="logradouro_user">Logradouro:</label>
                            <input type="text" id="logradouro_user" name="logradouro" placeholder="Rua, Avenida, etc." required>
                        </div>
                        <div class="form-group">
                            <label for="numero_user">Número:</label>
                            <input type="text" id="numero_user" name="numero" placeholder="Número" required>
                        </div>
                        <div class="form-group">
                            <label for="complemento_user">Complemento:</label>
                            <input type="text" id="complemento_user" name="complemento" placeholder="Apartamento, Bloco, etc. (Opcional)">
                        </div>
                        <div class="form-group">
                            <label for="bairro_user">Bairro:</label>
                            <input type="text" id="bairro_user" name="bairro" placeholder="Bairro" required>
                        </div>
                        <div class="form-group">
                            <label for="cidade_user">Cidade:</label>
                            <input type="text" id="cidade_user" name="cidade" placeholder="Cidade" required>
                        </div>
                        <div class="form-group">
                            <label for="estado_user">Estado:</label>
                            <input type="text" id="estado_user" name="estado" placeholder="Estado (Ex: SP)" maxlength="2" required>
                        </div>
                    </div>

                    <h3>Dados do Usuário (Funcionário)</h3>
                    <div class="form-group-grid">
                        <div class="form-group full-width">
                            <label for="tipo_cargo">Cargo:</label>
                            <select id="tipo_cargo" name="tipoCargo" required>
                                <option value="">Selecione o Cargo</option>
                                <option value="ADMINISTRADOR">Administrador do Sistema</option>
                                <option value="GERENTE">Gerente</option>
                                <option value="CORRETOR">Corretor</option>
                            </select>
                        </div>
                        <div class="form-group" id="area_atuacao_group" style="display: none;">
                            <label for="area_atuacao">Área de Atuação (Corretor):</label>
                            <input type="text" id="area_atuacao" name="areaAtuacao" placeholder="Ex: Zona Sul, Imóveis Comerciais">
                        </div>
                        <div class="form-group">
                            <label for="senha">Senha:</label>
                            <input type="password" id="senha" name="senha" placeholder="Crie uma senha" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmar_senha">Confirmar Senha:</label>
                            <input type="password" id="confirmar_senha" name="confirmarSenha" placeholder="Confirme a senha" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="ativo">Ativo:</label>
                            <input type="checkbox" id="ativo" name="ativo" checked>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="save-user-btn"><i class="fas fa-save"></i> Salvar Usuário</button>
                        <button type="button" class="btn btn-secondary" onclick="showSection('list-manage-users-content')"><i class="fas fa-times-circle"></i> Voltar à Listagem</button>
                        <button type="button" class="btn btn-error" id="delete-user-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Excluir Usuário</button>
                    </div>
                </form>
            </section>
            
            <section id="list-manage-users-content" class="content-section">
                <h2>Listar e Gerenciar Usuários</h2>
                <p>Abaixo, a lista completa de usuários cadastrados no sistema.</p>
                <div class="search-bar">
                    <input type="text" id="user-search-input" placeholder="Pesquisar por nome, chave primária ou cargo...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Chave Primária</th>
                                <th>Status</th>
                                <th>Cargo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            </tbody>
                    </table>
                </div>
            </section>


            <section id="clients-management-section" class="content-section">
                <h2>Gestão de Clientes</h2>
                <p>Gerencie informações e ações relacionadas aos clientes da imobiliária.</p>
                <div class="dashboard-stats">
                    <a href="#register-client-section" class="stat-card action-card sidebar-link" data-content-id="register-client-section">
                        <h3><i class="fas fa-user-plus"></i> Cadastrar Cliente</h3>
                        <p>Registre novos clientes no sistema.</p>
                    </a>
                    <a href="#list-manage-clients-content" class="stat-card action-card sidebar-link" data-content-id="list-manage-clients-content">
                        <h3><i class="fas fa-search"></i> Consultar Clientes</h3>
                        <p>Busque, visualize e atualize dados de clientes existentes.</p>
                    </a>
                </div>
            </section>

            <section id="register-client-section" class="content-section">
                <h2 id="client-form-title">Cadastrar Novo Cliente</h2>
                <p id="client-form-description">Preencha os campos abaixo para registrar um novo cliente no sistema.</p>
                <form action="/admin/clientes/salvar" method="POST" class="user-form" id="client-registration-form">
                    <input type="hidden" id="client_id" name="clientId">
                    <h3>Dados Pessoais</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="cpf_cnpj_select_client">Tipo de Documento:</label>
                            <select id="cpf_cnpj_select_client" name="documentType" required>
                                <option value="">Selecione</option>
                                <option value="CPF">CPF</option>
                                <option value="CNPJ">CNPJ</option>
                            </select>
                        </div>
                        <div class="form-group" id="cpf_group_client">
                            <label for="cpf_client">CPF:</label>
                            <input type="text" id="cpf_client" name="cpf" placeholder="Ex: 123.456.789-00" pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" oninput="this.value = formatCpf(this.value)">
                        </div>
                        <div class="form-group" id="cnpj_group_client" style="display: none;">
                            <label for="cnpj_client">CNPJ:</label>
                            <input type="text" id="cnpj_client" name="cnpj" placeholder="Ex: 00.000.000/0000-00" pattern="\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2}" oninput="this.value = formatCnpj(this.value)">
                        </div>
                        <div class="form-group full-width">
                            <label for="nome_client">Nome Completo:</label>
                            <input type="text" id="nome_client" name="nome" placeholder="Nome completo do cliente" required>
                        </div>
                        <div class="form-group">
                            <label for="email_client">Email:</label>
                            <input type="email" id="email_client" name="email" placeholder="email@exemplo.com" required>
                        </div>
                        <div class="form-group">
                            <label for="telefone_client">Telefone:</label>
                            <input type="tel" id="telefone_client" name="telefone" placeholder="Ex: (XX) XXXXX-XXXX" pattern="\(\d{2}\)\s\d{4,5}-\d{4}">
                        </div>
                    </div>

                    <h3>Endereço</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="cep_client">CEP:</label>
                            <input type="text" id="cep_client" name="cep" placeholder="Ex: XXXXX-XXX" pattern="\d{5}-\d{3}">
                        </div>
                        <div class="form-group">
                            <label for="logradouro_client">Logradouro:</label>
                            <input type="text" id="logradouro_client" name="logradouro" placeholder="Rua, Avenida, etc." required>
                        </div>
                        <div class="form-group">
                            <label for="numero_client">Número:</label>
                            <input type="text" id="numero_client" name="numero" placeholder="Número" required>
                        </div>
                        <div class="form-group">
                            <label for="complemento_client">Complemento:</label>
                            <input type="text" id="complemento_client" name="complemento" placeholder="Apartamento, Bloco, etc. (Opcional)">
                        </div>
                        <div class="form-group">
                            <label for="bairro_client">Bairro:</label>
                            <input type="text" id="bairro_client" name="bairro" placeholder="Bairro" required>
                        </div>
                        <div class="form-group">
                            <label for="cidade_client">Cidade:</label>
                            <input type="text" id="cidade_client" name="cidade" placeholder="Cidade" required>
                        </div>
                        <div class="form-group">
                            <label for="estado_client">Estado:</label>
                            <input type="text" id="estado_client" name="estado" placeholder="Estado (Ex: SP)" maxlength="2" required>
                        </div>
                    </div>

                    <h3>Dados do Cliente</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="data_cadastro_client">Data de Cadastro:</label>
                            <input type="date" id="data_cadastro_client" name="dataCadastro" required>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="save-client-btn"><i class="fas fa-save"></i> Salvar Cliente</button>
                        <button type="button" class="btn btn-secondary" onclick="showSection('list-manage-clients-content')"><i class="fas fa-times-circle"></i> Voltar à Listagem</button>
                        <button type="button" class="btn btn-error" id="delete-client-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Excluir Cliente</button>
                    </div>
                </form>
            </section>
            
            <section id="list-manage-clients-content" class="content-section">
                <h2>Consultar Clientes</h2>
                <p>Abaixo, a lista completa de clientes cadastrados no sistema.</p>
                <div class="search-bar">
                    <input type="text" id="client-search-input" placeholder="Pesquisar por nome ou chave primária...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table class="users-table"> <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Chave Primária</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Data de Cadastro</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="link-property-owner-section" class="content-section">
                <h2>Vincular Imóvel a Proprietário</h2>
                <p>Formulário para vincular cliente a um imóvel como proprietário.</p>
                </section>
            <section id="delete-clients-section" class="content-section">
                <h2>Excluir Clientes</h2>
                <p>Opção para excluir clientes do sistema.</p>
                </section>


            <section id="properties-management-section" class="content-section">
                <h2>Gestão de Imóveis</h2>
                <p>Gerencie o cadastro e as informações detalhadas dos imóveis.</p>
                <div class="dashboard-stats">
                    <a href="#register-property-section" class="stat-card action-card sidebar-link" data-content-id="register-property-section">
                        <h3><i class="fas fa-plus-square"></i> Cadastrar Imóvel</h3>
                        <p>Adicione novos imóveis ao portfólio da imobiliária.</p>
                    </a>
                    <a href="#list-manage-properties-content" class="stat-card action-card sidebar-link" data-content-id="list-manage-properties-content">
                        <h3><i class="fas fa-search-location"></i> Consultar Imóveis</h3>
                        <p>Busque e visualize imóveis por critérios específicos.</p>
                    </a>
                </div>
            </section>

            <section id="register-property-section" class="content-section">
                <h2 id="property-form-title">Cadastrar Novo Imóvel</h2>
                <p id="property-form-description">Preencha os campos abaixo para registrar um novo imóvel no sistema.</p>
                <form action="/admin/imoveis/salvar" method="POST" class="user-form" id="property-registration-form">
                    <input type="hidden" id="property_id" name="propertyId">
                    <h3>Dados Gerais do Imóvel</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="numero_matricula_imovel">Número de Matrícula:</label>
                            <input type="text" id="numero_matricula_imovel" name="numeroMatriculaImovel" placeholder="Ex: 123456-D" required>
                        </div>
                        <div class="form-group">
                            <label for="finalidade">Finalidade:</label>
                            <select id="finalidade" name="finalidade" required>
                                <option value="">Selecione</option>
                                <option value="VENDA">Venda</option>
                                <option value="ALUGUEL">Aluguel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="valor">Valor:</label>
                            <input type="number" id="valor" name="valor" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label for="area_total">Área Total (m²):</label>
                            <input type="number" id="area_total" name="areaTotal" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status" name="status" required>
                                <option value="DISPONIVEL">Disponível</option>
                                <option value="VENDIDO">Vendido</option>
                                <option value="ALUGADO">Alugado</option>
                                <option value="EM_NEGOCIACAO">Em Negociação</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="data_cadastro_imovel">Data de Cadastro:</label>
                            <input type="date" id="data_cadastro_imovel" name="dataCadastro" required>
                        </div>
                        <div class="form-group">
                            <label for="data_atualizacao_imovel">Data de Atualização:</label>
                            <input type="date" id="data_atualizacao_imovel" name="dataAtualizacao">
                        </div>
                        <div class="form-group full-width">
                            <label for="proprietario_imovel_select">Proprietário (Cliente):</label>
                            <select id="proprietario_imovel_select" name="proprietarioImovel" required>
                                <option value="">Selecione o Cliente Proprietário</option>
                                <option value="c1">Maria Eduarda Costa (CPF: 000...)</option>
                                <option value="c2">Construtora Solida S.A. (CNPJ: 45...)</option>
                                <option value="c3">João Pedro Alves (CPF: 333...)</option>
                            </select>
                        </div>
                    </div>

                    <h3>Endereço do Imóvel</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="cep_imovel">CEP:</label>
                            <input type="text" id="cep_imovel" name="cep" placeholder="Ex: XXXXX-XXX" pattern="\d{5}-\d{3}" required>
                        </div>
                        <div class="form-group">
                            <label for="logradouro_imovel">Logradouro:</label>
                            <input type="text" id="logradouro_imovel" name="logradouro" placeholder="Rua, Avenida, etc." required>
                        </div>
                        <div class="form-group">
                            <label for="numero_imovel">Número:</label>
                            <input type="text" id="numero_imovel" name="numero" placeholder="Número" required>
                        </div>
                        <div class="form-group">
                            <label for="complemento_imovel">Complemento:</label>
                            <input type="text" id="complemento_imovel" name="complemento" placeholder="Apartamento, Bloco, etc. (Opcional)">
                        </div>
                        <div class="form-group">
                            <label for="bairro_imovel">Bairro:</label>
                            <input type="text" id="bairro_imovel" name="bairro" placeholder="Bairro" required>
                        </div>
                        <div class="form-group">
                            <label for="cidade_imovel">Cidade:</label>
                            <input type="text" id="cidade_imovel" name="cidade" placeholder="Cidade" required>
                        </div>
                        <div class="form-group">
                            <label for="estado_imovel">Estado:</label>
                            <input type="text" id="estado_imovel" name="estado" placeholder="Estado (Ex: SP)" maxlength="2" required>
                        </div>
                    </div>

                    <h3>Detalhes do Tipo de Imóvel</h3>
                    <div class="form-group full-width">
                        <label for="tipo_imovel_select">Tipo de Imóvel:</label>
                        <select id="tipo_imovel_select" name="tipoImovel" required>
                            <option value="">Selecione o Tipo</option>
                            <option value="TERRENO">Terreno</option>
                            <option value="CASA">Casa</option>
                            <option value="APARTAMENTO">Apartamento</option>
                            <option value="PREDIO_COMERCIAL">Prédio Comercial</option>
                            <option value="SALA_COMERCIAL">Sala Comercial</option>
                        </select>
                    </div>

                    <div id="terreno_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group">
                            <label for="topografia">Topografia:</label>
                            <input type="text" id="topografia" name="topografia" placeholder="Ex: Plana, Aclive, Declive">
                        </div>
                        <div class="form-group">
                            <label for="tipo_solo">Tipo de Solo:</label>
                            <input type="text" id="tipo_solo" name="tipoSolo" placeholder="Ex: Argiloso, Arenoso">
                        </div>
                    </div>

                    <div id="unidade_residencial_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group">
                            <label for="numero_quartos">Nº de Quartos:</label>
                            <input type="number" id="numero_quartos" name="numeroQuartos" min="0">
                        </div>
                        <div class="form-group">
                            <label for="numero_banheiros">Nº de Banheiros:</label>
                            <input type="number" id="numero_banheiros" name="numeroBanheiros" min="0">
                        </div>
                        <div class="form-group">
                            <label for="numero_suites">Nº de Suítes:</label>
                            <input type="number" id="numero_suites" name="numeroSuites" min="0">
                        </div>
                        <div class="form-group">
                            <label for="area_construida">Área Construída (m²):</label>
                            <input type="number" id="area_construida" name="areaConstruida" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="numero_vagas_garagem">Nº Vagas Garagem:</label>
                            <input type="number" id="numero_vagas_garagem" name="numeroVagasGaragem" min="0">
                        </div>
                        <div class="form-group full-width">
                            <label for="descricao_residencial">Descrição:</label>
                            <textarea id="descricao_residencial" name="descricaoResidencial" rows="3" placeholder="Detalhes adicionais da unidade residencial."></textarea>
                        </div>
                    </div>

                    <div id="casa_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group full-width">
                            <label for="possui_quintal">Possui Quintal?</label>
                            <input type="checkbox" id="possui_quintal" name="possuiQuintal">
                        </div>
                        <div class="form-group">
                            <label for="numero_pavimentos">Nº de Pavimentos:</label>
                            <input type="number" id="numero_pavimentos" name="numeroPavimentos" min="1">
                        </div>
                    </div>

                    <div id="apartamento_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group">
                            <label for="andar">Andar:</label>
                            <input type="number" id="andar" name="andar" min="0">
                        </div>
                        <div class="form-group">
                            <label for="numero_apartamento">Nº do Apartamento:</label>
                            <input type="text" id="numero_apartamento" name="numeroApartamento" placeholder="Ex: 101, Apto B">
                        </div>
                        <div class="form-group full-width">
                            <label for="possui_elevador">Possui Elevador?</label>
                            <input type="checkbox" id="possui_elevador" name="possuiElevador">
                        </div>
                    </div>

                    <div id="unidade_comercial_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group">
                            <label for="area_util">Área Útil (m²):</label>
                            <input type="number" id="area_util" name="areaUtil" step="0.01" min="0">
                        </div>
                        <div class="form-group full-width">
                            <label for="descricao_comercial">Descrição:</label>
                            <textarea id="descricao_comercial" name="descricaoComercial" rows="3" placeholder="Detalhes adicionais da unidade comercial."></textarea>
                        </div>
                    </div>

                    <div id="predio_comercial_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group">
                            <label for="total_andares">Total de Andares:</label>
                            <input type="number" id="total_andares" name="totalAndares" min="1">
                        </div>
                        <div class="form-group">
                            <label for="numero_salas">Nº de Salas:</label>
                            <input type="number" id="numero_salas" name="numeroSalas" min="0">
                        </div>
                        <div class="form-group full-width">
                            <label for="possui_estacionamento">Possui Estacionamento?</label>
                            <input type="checkbox" id="possui_estacionamento" name="possuiEstacionamento">
                        </div>
                    </div>

                    <div id="sala_comercial_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group">
                            <label for="andar_sala">Andar:</label>
                            <input type="number" id="andar_sala" name="andarSala" min="0">
                        </div>
                        <div class="form-group">
                            <label for="numero_sala">Nº da Sala:</label>
                            <input type="text" id="numero_sala" name="numeroSala" placeholder="Ex: 501, Sala X">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="save-property-btn"><i class="fas fa-save"></i> Salvar Imóvel</button>
                        <button type="button" class="btn btn-secondary" onclick="showSection('list-manage-properties-content')"><i class="fas fa-times-circle"></i> Voltar à Listagem</button>
                        <button type="button" class="btn btn-error" id="delete-property-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Excluir Imóvel</button>
                    </div>
                </form>
            </section>
            
            <section id="list-manage-properties-content" class="content-section">
                <h2>Consultar Imóveis</h2>
                <p>Abaixo, a lista completa de imóveis cadastrados no sistema.</p>
                <div class="search-bar">
                    <input type="text" id="property-search-input" placeholder="Pesquisar por endereço, matrícula ou finalidade...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table class="users-table"> <thead>
                            <tr>
                                <th>Matrícula</th>
                                <th>Endereço Completo</th>
                                <th>Finalidade</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Proprietário</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="properties-table-body">
                            </tbody>
                    </table>
                </div>
            </section>


            <section id="visits-interests-management-section" class="content-section">
                <h2>Gestão de Visitas e Interesses</h2>
                <p>Gerencie o registro de visitas e os interesses dos clientes em imóveis.</p>
                <div class="dashboard-stats">
                    <a href="#register-visit-interest-section" class="stat-card action-card sidebar-link" data-content-id="register-visit-interest-section">
                        <h3><i class="fas fa-calendar-plus"></i> Registrar Visita e Interesse</h3>
                        <p>Registre novas visitas e as avaliações de interesse do cliente no mesmo fluxo.</p>
                    </a>
                    <a href="#consult-visits-section" class="stat-card action-card sidebar-link" data-content-id="consult-visits-section">
                        <h3><i class="fas fa-calendar-check"></i> Consultar Visitas</h3>
                        <p>Visualize o histórico de visitas vinculadas a clientes ou imóveis.</p>
                    </a>
                    <a href="#property-suggestions-section" class="stat-card action-card sidebar-link" data-content-id="property-suggestions-section">
                        <h3><i class="fas fa-lightbulb"></i> Sugestões de Imóveis</h3>
                        <p>Calcule e visualize imóveis adequados ao perfil dos clientes.</p>
                    </a>
                </div>
            </section>

            <section id="register-visit-interest-section" class="content-section">
                <h2 id="visit-form-title">Registrar Visita e Interesse</h2>
                <p id="visit-form-description">Preencha os campos abaixo para registrar uma nova visita e a avaliação de interesse.</p>
                <form action="/admin/visitas/salvar" method="POST" class="user-form" id="visit-registration-form">
                    <input type="hidden" id="visit_id" name="visitId">
                    <h3>Detalhes da Visita</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="cliente_visita_select">Cliente:</label>
                            <select id="cliente_visita_select" name="clienteVisita" required>
                                <option value="">Selecione o Cliente</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="imovel_visita_select">Imóvel Visitado:</label>
                            <select id="imovel_visita_select" name="imovelVisita" required>
                                <option value="">Selecione o Imóvel</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="corretor_visita_select">Corretor Responsável:</label>
                            <select id="corretor_visita_select" name="corretorVisita" required>
                                <option value="">Selecione o Corretor</option>
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="data_hora_visita">Data e Hora da Visita:</label>
                            <input type="datetime-local" id="data_hora_visita" name="dataHoraVisita" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="observacoes_visita">Observações da Visita:</label>
                            <textarea id="observacoes_visita" name="observacoesVisita" rows="3" placeholder="Detalhes sobre a visita."></textarea>
                        </div>
                    </div>

                    <h3 id="avaliacao_imovel_title" style="display: none;">Avaliação do Imóvel (Interesse)</h3>
                    <p id="avaliacao_imovel_desc" style="display: none;">Atribua uma nota de 1 a 5 estrelas para as características do imóvel. (Campos só aparecerão após seleção de imóvel)</p>
                    
                    <div id="avaliacao_fields" class="form-group-grid type-specific-fields" style="display: none;">
                        <div class="form-group" data-interest-field="bairro">
                            <label for="avaliacao_bairro">Bairro:</label>
                            <div class="rating">
                                <input type="radio" id="bairro5" name="avaliacao_bairro" value="5"><label for="bairro5"></label>
                                <input type="radio" id="bairro4" name="avaliacao_bairro" value="4"><label for="bairro4"></label>
                                <input type="radio" id="bairro3" name="avaliacao_bairro" value="3"><label for="bairro3"></label>
                                <input type="radio" id="bairro2" name="avaliacao_bairro" value="2"><label for="bairro2"></label>
                                <input type="radio" id="bairro1" name="avaliacao_bairro" value="1"><label for="bairro1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="cidade">
                            <label for="avaliacao_cidade">Cidade:</label>
                            <div class="rating">
                                <input type="radio" id="cidade5" name="avaliacao_cidade" value="5"><label for="cidade5"></label>
                                <input type="radio" id="cidade4" name="avaliacao_cidade" value="4"><label for="cidade4"></label>
                                <input type="radio" id="cidade3" name="avaliacao_cidade" value="3"><label for="cidade3"></label>
                                <input type="radio" id="cidade2" name="avaliacao_cidade" value="2"><label for="cidade2"></label>
                                <input type="radio" id="cidade1" name="avaliacao_cidade" value="1"><label for="cidade1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="estado">
                            <label for="avaliacao_estado">Estado:</label>
                            <div class="rating">
                                <input type="radio" id="estado5" name="avaliacao_estado" value="5"><label for="estado5"></label>
                                <input type="radio" id="estado4" name="avaliacao_estado" value="4"><label for="estado4"></label>
                                <input type="radio" id="estado3" name="avaliacao_estado" value="3"><label for="estado3"></label>
                                <input type="radio" id="estado2" name="avaliacao_estado" value="2"><label for="estado2"></label>
                                <input type="radio" id="estado1" name="avaliacao_estado" value="1"><label for="estado1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="areaTotal">
                            <label for="avaliacao_area_total">Área Total:</label>
                            <div class="rating">
                                <input type="radio" id="areatotal5" name="avaliacao_area_total" value="5"><label for="areatotal5"></label>
                                <input type="radio" id="areatotal4" name="avaliacao_area_total" value="4"><label for="areatotal4"></label>
                                <input type="radio" id="areatotal3" name="avaliacao_area_total" value="3"><label for="areatotal3"></label>
                                <input type="radio" id="areatotal2" name="avaliacao_area_total" value="2"><label for="areatotal2"></label>
                                <input type="radio" id="areatotal1" name="avaliacao_area_total" value="1"><label for="areatotal1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="valor">
                            <label for="avaliacao_valor">Valor:</label>
                            <div class="rating">
                                <input type="radio" id="valor5" name="avaliacao_valor" value="5"><label for="valor5"></label>
                                <input type="radio" id="valor4" name="avaliacao_valor" value="4"><label for="valor4"></label>
                                <input type="radio" id="valor3" name="avaliacao_valor" value="3"><label for="valor3"></label>
                                <input type="radio" id="valor2" name="avaliacao_valor" value="2"><label for="valor2"></label>
                                <input type="radio" id="valor1" name="avaliacao_valor" value="1"><label for="valor1"></label>
                            </div>
                        </div>

                        <div class="form-group" data-interest-field="topografia">
                            <label for="avaliacao_topografia">Topografia:</label>
                            <div class="rating">
                                <input type="radio" id="topografia5" name="avaliacao_topografia" value="5"><label for="topografia5"></label>
                                <input type="radio" id="topografia4" name="avaliacao_topografia" value="4"><label for="topografia4"></label>
                                <input type="radio" id="topografia3" name="avaliacao_topografia" value="3"><label for="topografia3"></label>
                                <input type="radio" id="topografia2" name="avaliacao_topografia" value="2"><label for="topografia2"></label>
                                <input type="radio" id="topografia1" name="avaliacao_topografia" value="1"><label for="topografia1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="tipoSolo">
                            <label for="avaliacao_tipo_solo">Tipo de Solo:</label>
                            <div class="rating">
                                <input type="radio" id="tiposolo5" name="avaliacao_tipo_solo" value="5"><label for="tiposolo5"></label>
                                <input type="radio" id="tiposolo4" name="avaliacao_tipo_solo" value="4"><label for="tiposolo4"></label>
                                <input type="radio" id="tiposolo3" name="avaliacao_tipo_solo" value="3"><label for="tiposolo3"></label>
                                <input type="radio" id="tiposolo2" name="avaliacao_tipo_solo" value="2"><label for="tiposolo2"></label>
                                <input type="radio" id="tiposolo1" name="avaliacao_tipo_solo" value="1"><label for="tiposolo1"></label>
                            </div>
                        </div>

                        <div class="form-group" data-interest-field="numeroQuartos">
                            <label for="avaliacao_quartos">Quartos:</label>
                            <div class="rating">
                                <input type="radio" id="quartos5" name="avaliacao_quartos" value="5"><label for="quartos5"></label>
                                <input type="radio" id="quartos4" name="avaliacao_quartos" value="4"><label for="quartos4"></label>
                                <input type="radio" id="quartos3" name="avaliacao_quartos" value="3"><label for="quartos3"></label>
                                <input type="radio" id="quartos2" name="avaliacao_quartos" value="2"><label for="quartos2"></label>
                                <input type="radio" id="quartos1" name="avaliacao_quartos" value="1"><label for="quartos1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="numeroBanheiros">
                            <label for="avaliacao_banheiros">Banheiros:</label>
                            <div class="rating">
                                <input type="radio" id="banheiros5" name="avaliacao_banheiros" value="5"><label for="banheiros5"></label>
                                <input type="radio" id="banheiros4" name="avaliacao_banheiros" value="4"><label for="banheiros4"></label>
                                <input type="radio" id="banheiros3" name="avaliacao_banheiros" value="3"><label for="banheiros3"></label>
                                <input type="radio" id="banheiros2" name="avaliacao_banheiros" value="2"><label for="banheiros2"></label>
                                <input type="radio" id="banheiros1" name="avaliacao_banheiros" value="1"><label for="banheiros1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="numeroSuites">
                            <label for="avaliacao_suites">Suítes:</label>
                            <div class="rating">
                                <input type="radio" id="suites5" name="avaliacao_suites" value="5"><label for="suites5"></label>
                                <input type="radio" id="suites4" name="avaliacao_suites" value="4"><label for="suites4"></label>
                                <input type="radio" id="suites3" name="avaliacao_suites" value="3"><label for="suites3"></label>
                                <input type="radio" id="suites2" name="avaliacao_suites" value="2"><label for="suites2"></label>
                                <input type="radio" id="suites1" name="avaliacao_suites" value="1"><label for="suites1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="areaConstruida">
                            <label for="avaliacao_construida">Área Construída:</label>
                            <div class="rating">
                                <input type="radio" id="construida5" name="avaliacao_construida" value="5"><label for="construida5"></label>
                                <input type="radio" id="construida4" name="avaliacao_construida" value="4"><label for="construida4"></label>
                                <input type="radio" id="construida3" name="avaliacao_construida" value="3"><label for="construida3"></label>
                                <input type="radio" id="construida2" name="avaliacao_construida" value="2"><label for="construida2"></label>
                                <input type="radio" id="construida1" name="avaliacao_construida" value="1"><label for="construida1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="numeroVagasGaragem">
                            <label for="avaliacao_garagem">Vagas Garagem:</label>
                            <div class="rating">
                                <input type="radio" id="garagem5" name="avaliacao_garagem" value="5"><label for="garagem5"></label>
                                <input type="radio" id="garagem4" name="avaliacao_garagem" value="4"><label for="garagem4"></label>
                                <input type="radio" id="garagem3" name="avaliacao_garagem" value="3"><label for="garagem3"></label>
                                <input type="radio" id="garagem2" name="avaliacao_garagem" value="2"><label for="garagem2"></label>
                                <input type="radio" id="garagem1" name="avaliacao_garagem" value="1"><label for="garagem1"></label>
                            </div>
                        </div>

                        <div class="form-group" data-interest-field="possuiQuintal">
                            <label for="avaliacao_quintal">Quintal:</label>
                            <div class="rating">
                                <input type="radio" id="quintal5" name="avaliacao_quintal" value="5"><label for="quintal5"></label>
                                <input type="radio" id="quintal4" name="avaliacao_quintal" value="4"><label for="quintal4"></label>
                                <input type="radio" id="quintal3" name="avaliacao_quintal" value="3"><label for="quintal3"></label>
                                <input type="radio" id="quintal2" name="avaliacao_quintal" value="2"><label for="quintal2"></label>
                                <input type="radio" id="quintal1" name="avaliacao_quintal" value="1"><label for="quintal1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="numeroPavimentos">
                            <label for="avaliacao_numero_pavimentos">Nº Pavimentos:</label>
                            <div class="rating">
                                <input type="radio" id="pavimentos5" name="avaliacao_numero_pavimentos" value="5"><label for="pavimentos5"></label>
                                <input type="radio" id="pavimentos4" name="avaliacao_numero_pavimentos" value="4"><label for="pavimentos4"></label>
                                <input type="radio" id="pavimentos3" name="avaliacao_numero_pavimentos" value="3"><label for="pavimentos3"></label>
                                <input type="radio" id="pavimentos2" name="avaliacao_numero_pavimentos" value="2"><label for="pavimentos2"></label>
                                <input type="radio" id="pavimentos1" name="avaliacao_numero_pavimentos" value="1"><label for="pavimentos1"></label>
                            </div>
                        </div>

                        <div class="form-group" data-interest-field="andar">
                            <label for="avaliacao_andar_apartamento">Andar Apartamento:</label>
                            <div class="rating">
                                <input type="radio" id="andarap5" name="avaliacao_andar_apartamento" value="5"><label for="andarap5"></label>
                                <input type="radio" id="andarap4" name="avaliacao_andar_apartamento" value="4"><label for="andarap4"></label>
                                <input type="radio" id="andarap3" name="avaliacao_andar_apartamento" value="3"><label for="andarap3"></label>
                                <input type="radio" id="andarap2" name="avaliacao_andar_apartamento" value="2"><label for="andarap2"></label>
                                <input type="radio" id="andarap1" name="avaliacao_andar_apartamento" value="1"><label for="andarap1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="possuiElevador">
                            <label for="avaliacao_elevador">Elevador:</label>
                            <div class="rating">
                                <input type="radio" id="elevador5" name="avaliacao_elevador" value="5"><label for="elevador5"></label>
                                <input type="radio" id="elevador4" name="avaliacao_elevador" value="4"><label for="elevador4"></label>
                                <input type="radio" id="elevador3" name="avaliacao_elevador" value="3"><label for="elevador3"></label>
                                <input type="radio" id="elevador2" name="avaliacao_elevador" value="2"><label for="elevador2"></label>
                                <input type="radio" id="elevador1" name="avaliacao_elevador" value="1"><label for="elevador1"></label>
                            </div>
                        </div>

                        <div class="form-group" data-interest-field="areaUtil">
                            <label for="avaliacao_area_util">Área Útil:</label>
                            <div class="rating">
                                <input type="radio" id="areautil5" name="avaliacao_area_util" value="5"><label for="areautil5"></label>
                                <input type="radio" id="areautil4" name="avaliacao_area_util" value="4"><label for="areautil4"></label>
                                <input type="radio" id="areautil3" name="avaliacao_area_util" value="3"><label for="areautil3"></label>
                                <input type="radio" id="areautil2" name="avaliacao_area_util" value="2"><label for="areautil2"></label>
                                <input type="radio" id="areautil1" name="avaliacao_area_util" value="1"><label for="areautil1"></label>
                            </div>
                        </div>

                        <div class="form-group" data-interest-field="totalAndares">
                            <label for="avaliacao_total_andares">Total Andares:</label>
                            <div class="rating">
                                <input type="radio" id="totalandares5" name="avaliacao_total_andares" value="5"><label for="totalandares5"></label>
                                <input type="radio" id="totalandares4" name="avaliacao_total_andares" value="4"><label for="totalandares4"></label>
                                <input type="radio" id="totalandares3" name="avaliacao_total_andares" value="3"><label for="totalandares3"></label>
                                <input type="radio" id="totalandares2" name="avaliacao_total_andares" value="2"><label for="totalandares2"></label>
                                <input type="radio" id="totalandares1" name="avaliacao_total_andares" value="1"><label for="totalandares1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="numeroSalas">
                            <label for="avaliacao_salas">Salas:</label>
                            <div class="rating">
                                <input type="radio" id="salas5" name="avaliacao_salas" value="5"><label for="salas5"></label>
                                <input type="radio" id="salas4" name="avaliacao_salas" value="4"><label for="salas4"></label>
                                <input type="radio" id="salas3" name="avaliacao_salas" value="3"><label for="salas3"></label>
                                <input type="radio" id="salas2" name="avaliacao_salas" value="2"><label for="salas2"></label>
                                <input type="radio" id="salas1" name="avaliacao_salas" value="1"><label for="salas1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="possuiEstacionamento">
                            <label for="avaliacao_estacionamento">Estacionamento:</label>
                            <div class="rating">
                                <input type="radio" id="estacionamento5" name="avaliacao_estacionamento" value="5"><label for="estacionamento5"></label>
                                <input type="radio" id="estacionamento4" name="avaliacao_estacionamento" value="4"><label for="estacionamento4"></label>
                                <input type="radio" id="estacionamento3" name="avaliacao_estacionamento" value="3"><label for="estacionamento3"></label>
                                <input type="radio" id="estacionamento2" name="avaliacao_estacionamento" value="2"><label for="estacionamento2"></label>
                                <input type="radio" id="estacionamento1" name="avaliacao_estacionamento" value="1"><label for="estacionamento1"></label>
                            </div>
                        </div>

                        <div class="form-group" data-interest-field="andarSala">
                            <label for="avaliacao_andar_sala">Andar Sala:</label>
                            <div class="rating">
                                <input type="radio" id="andarsala5" name="avaliacao_andar_sala" value="5"><label for="andarsala5"></label>
                                <input type="radio" id="andarsala4" name="avaliacao_andar_sala" value="4"><label for="andarsala4"></label>
                                <input type="radio" id="andarsala3" name="avaliacao_andar_sala" value="3"><label for="andarsala3"></label>
                                <input type="radio" id="andarsala2" name="avaliacao_andar_sala" value="2"><label for="andarsala2"></label>
                                <input type="radio" id="andarsala1" name="avaliacao_andar_sala" value="1"><label for="andarsala1"></label>
                            </div>
                        </div>
                        <div class="form-group" data-interest-field="numeroSala">
                            <label for="avaliacao_sala">Sala Comercial (Número):</label>
                            <div class="rating">
                                <input type="radio" id="sala5" name="avaliacao_sala" value="5"><label for="sala5"></label>
                                <input type="radio" id="sala4" name="avaliacao_sala" value="4"><label for="sala4"></label>
                                <input type="radio" id="sala3" name="avaliacao_sala" value="3"><label for="sala3"></label>
                                <input type="radio" id="sala2" name="avaliacao_sala" value="2"><label for="sala2"></label>
                                <input type="radio" id="sala1" name="avaliacao_sala" value="1"><label for="sala1"></label>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="save-visit-btn"><i class="fas fa-save"></i> Salvar Visita e Interesse</button>
                        <button type="button" class="btn btn-secondary" onclick="showSection('consult-visits-section')"><i class="fas fa-times-circle"></i> Voltar à Listagem</button>
                        <button type="button" class="btn btn-error" id="delete-visit-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Excluir Visita</button>
                    </div>
                </form>
            </section>
            
            <section id="consult-visits-section" class="content-section">
                <h2>Consultar Visitas</h2>
                <p>Abaixo, a lista completa de visitas registradas no sistema.</p>
                <div class="search-bar">
                    <input type="text" id="visit-search-input" placeholder="Pesquisar por cliente, imóvel ou corretor...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Imóvel</th>
                                <th>Corretor</th>
                                <th>Data/Hora</th>
                                <th>Observações</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="visits-table-body">
                            </tbody>
                    </table>
                </div>
            </section>
            <section id="register-new-interest-section" class="content-section">
                <h2>Registrar Novo Interesse</h2>
                <p>Formulário para registrar ou atualizar interesse para uma visita já realizada.</p>
                </section>
            <section id="delete-visit-section" class="content-section">
                <h2>Excluir Visita</h2>
                <p>Opção para excluir registros de visitas.</p>
                </section>
            <section id="property-suggestions-section" class="content-section">
                <h2>Sugestões de Imóveis</h2>
                <p>Pesquise e selecione um cliente para ver as sugestões de imóveis compatíveis.</p>
                <div class="search-bar">
                    <input type="text" id="client-suggestion-search-input" placeholder="Pesquisar cliente por nome ou chave primária...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Nome do Cliente</th>
                                <th>Chave Primária</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clients-for-suggestion-table-body">
                            </tbody>
                    </table>
                </div>

                <h3>Imóveis Sugeridos para <span id="selected-client-name-for-suggestions"></span></h3>
                <div class="dashboard-stats" id="suggested-properties-gallery">
                    <p style="grid-column: 1 / -1; text-align: center; color: var(--color-secondary);">Selecione um cliente acima para ver as sugestões de imóveis.</p>
                </div>
            </section>


            <section id="sales-management-section" class="content-section">
                <h2>Gestão de Vendas</h2>
                <p>Gerencie todo o processo de compra e venda de imóveis.</p>
                <div class="dashboard-stats">
                    <a href="#register-sale-section" class="stat-card action-card sidebar-link" data-content-id="register-sale-section">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Registrar Venda</h3>
                        <p>Registre novas transações de compra e venda.</p>
                    </a>
                    <a href="#track-sales-section" class="stat-card action-card sidebar-link" data-content-id="track-sales-section">
                        <h3><i class="fas fa-chart-line"></i> Acompanhar Vendas</h3>
                        <p>Monitore o status e os detalhes das vendas.</p>
                    </a>
                </div>
            </section>

            <section id="register-sale-section" class="content-section">
                <h2 id="sale-form-title">Registrar Nova Venda</h2>
                <p id="sale-form-description">Preencha os campos abaixo para registrar uma nova venda no sistema.</p>
                <form action="/admin/vendas/salvar" method="POST" class="user-form" id="sale-registration-form">
                    <input type="hidden" id="sale_id" name="saleId">
                    <h3>Detalhes da Venda</h3>
                    <div class="form-group-grid">
                        <div class="form-group">
                            <label for="imovel_venda_select">Imóvel Vendido (Matrícula):</label>
                            <select id="imovel_venda_select" name="numeroMatriculaImovel" required>
                                <option value="">Selecione o Imóvel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cliente_comprador_select">Cliente Comprador:</label>
                            <select id="cliente_comprador_select" name="cpfCnpjClienteComprador" required>
                                <option value="">Selecione o Comprador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="proprietario_imovel_venda_select">Proprietário do Imóvel:</label>
                            <select id="proprietario_imovel_venda_select" name="cpfCnpjProprietarioImovel" required disabled>
                                <option value="">Proprietário (automático)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="corretor_venda_select">Corretor Responsável:</label>
                            <select id="corretor_venda_select" name="cpfCnpjCorretor" required>
                                <option value="">Selecione o Corretor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="data_venda">Data da Venda:</label>
                            <input type="datetime-local" id="data_venda" name="dataVenda" required>
                        </div>
                        <div class="form-group">
                            <label for="valor_final">Valor Final:</label>
                            <input type="number" id="valor_final" name="valorFinal" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="save-sale-btn"><i class="fas fa-save"></i> Salvar Venda</button>
                        <button type="button" class="btn btn-secondary" onclick="showSection('track-sales-section')"><i class="fas fa-times-circle"></i> Voltar à Listagem</button>
                        <button type="button" class="btn btn-error" id="delete-sale-btn" style="display: none;"><i class="fas fa-trash-alt"></i> Excluir Venda</button>
                    </div>
                </form>
            </section>
            <section id="track-sales-section" class="content-section">
                <h2>Acompanhar Vendas</h2>
                <p>Abaixo, a lista completa de vendas registradas no sistema.</p>
                <div class="search-bar">
                    <input type="text" id="sale-search-input" placeholder="Pesquisar por imóvel, comprador ou corretor...">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Imóvel</th>
                                <th>Comprador</th>
                                <th>Proprietário</th>
                                <th>Corretor</th>
                                <th>Data da Venda</th>
                                <th>Valor Final</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body">
                            </tbody>
                    </table>
                </div>
            </section>
            <section id="delete-sale-section" class="content-section">
                <h2>Excluir Venda</h2>
                <p>Opção para excluir vendas.</p>
                </section>

        </main>
    </div>

    <script>
        // Comentário: Define a URL base para todas as requisições à API.
        const API_BASE_URL = 'http://localhost:8080/api'; // Substitua pela URL do seu backend Spring
        // Comentário: Chave para armazenar e recuperar o token JWT do sessionStorage.
        const AUTH_TOKEN_KEY = 'masterhouse_jwt_token';

        // Comentário: Funções auxiliares para gerenciar o token JWT no sessionStorage.
        const getToken = () => sessionStorage.getItem(AUTH_TOKEN_KEY);
        const removeToken = () => sessionStorage.removeItem(AUTH_TOKEN_KEY);

        // Comentário: Removemos os 'sampleData' globais, pois os dados virão do backend.
        // As referências a esses dados fictícios serão substituídas por chamadas assíncronas ao backend.
        // As demais variáveis de elementos HTML e funções auxiliares permanecem inalteradas.
        

        // Função para gerar as estrelas de avaliação
        const generateStarRating = (rating) => {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += `<span class="star filled-star"></span>`; // Estrela preenchida
                } else {
                    starsHtml += `<span class="star"></span>`; // Estrela vazia
                }
            }
            return `<div class="rating-display">${starsHtml}</div>`;
        };
         const typeFieldGroups = {
            'TERRENO': ['terreno_fields'],
            'CASA': ['unidade_residencial_fields', 'casa_fields'],
            'APARTAMENTO': ['unidade_residencial_fields', 'apartamento_fields'],
            'PREDIO_COMERCIAL': ['unidade_comercial_fields', 'predio_comercial_fields'],
            'SALA_COMERCIAL': ['unidade_comercial_fields', 'sala_comercial_fields']
    };

        // Função showSection movida para o escopo global
        const showSection = (contentId) => {
            const contentSections = document.querySelectorAll('.content-section');
            const sidebarLinks = document.querySelectorAll('.sidebar-link'); 

            // Variáveis de formulário que podem ser usadas em múltiplas chamadas
            const userIdInput = document.getElementById('user_id');
            const clientIdInput = document.getElementById('client_id');
            const propertyIdInput = document.getElementById('property_id');
            const visitIdInput = document.getElementById('visit_id');
            const saleIdInput = document.getElementById('sale_id'); // Nova para Vendas

            const userSearchInput = document.getElementById('user-search-input');
            const clientSearchInput = document.getElementById('client-search-input');
            const propertySearchInput = document.getElementById('property-search-input');
            const visitSearchInput = document.getElementById('visit-search-input');
            const clientSuggestionSearchInput = document.getElementById('client-suggestion-search-input'); 
            const clientsForSuggestionTableBody = document.getElementById('clients-for-suggestion-table-body');
            const selectedClientNameForSuggestions = document.getElementById('selected-client-name-for-suggestions');
            const suggestedPropertiesGallery = document.getElementById('suggested-properties-gallery');
            const saleSearchInput = document.getElementById('sale-search-input'); // Nova para Vendas


            const tipoImovelSelect = document.getElementById('tipo_imovel_select');
            const allTypeSpecificFieldDivs = document.querySelectorAll('.type-specific-fields'); 
            const imovelVisitaSelect = document.getElementById('imovel_visita_select');
            const avaliacaoFields = document.getElementById('avaliacao_fields');
            const avaliacaoImovelTitle = document.getElementById('avaliacao_imovel_title');
            const avaliacaoImovelDesc = document.getElementById('avaliacao_imovel_desc');

            // Selects de Venda
            const imovelVendaSelect = document.getElementById('imovel_venda_select');
            const clienteCompradorSelect = document.getElementById('cliente_comprador_select');
            const proprietarioImovelVendaSelect = document.getElementById('proprietario_imovel_venda_select');
            const corretorVendaSelect = document.getElementById('corretor_venda_select');


            contentSections.forEach(section => {
                section.classList.remove('active');
                section.style.opacity = '0';
                section.style.display = 'none';
            });

            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                // Adicionado para lidar com os links do dashboard que agora também usam showSection
                if (link.dataset.contentId === contentId || (link.getAttribute('href') && link.getAttribute('href').substring(1) === contentId)) {
                    link.classList.add('active');
                }
            });
            
            const targetSection = document.getElementById(contentId);

             if (targetSection) {
                targetSection.style.display = 'block';
                void targetSection.offsetWidth;
                targetSection.classList.add('active');
                targetSection.style.opacity = '1';

                // Comentário: Nova lógica: Ao exibir a seção do dashboard, carrega as estatísticas.
                if (contentId === 'dashboard-section') { 
                    loadDashboardStats();
                }
            
                // Lógica específica para cada seção ao exibi-la
                if (contentId === 'list-manage-users-content') {
                    loadUsersTable();
                    if (userSearchInput) {
                        userSearchInput.value = '';
                    }
                } else if (contentId === 'register-user-section' && userIdInput && !userIdInput.value) {
                    resetUserForm();
                } 
                else if (contentId === 'list-manage-clients-content') {
                    loadClientsTable();
                    if (clientSearchInput) {
                        clientSearchInput.value = '';
                    }
                } else if (contentId === 'register-client-section' && clientIdInput && !clientIdInput.value) {
                    resetClientForm();
                }
                else if (contentId === 'list-manage-properties-content') {
                    loadPropertiesTable();
                    if (propertySearchInput) {
                        propertySearchInput.value = '';
                    }
                } else if (contentId === 'register-property-section' && propertyIdInput && !propertyIdInput.value) {
                    resetPropertyForm();
                }
                // Lógica para Visitas e Interesses
                else if (contentId === 'consult-visits-section') {
                    loadVisitsTable();
                    if (visitSearchInput) {
                        visitSearchInput.value = '';
                    }
                } else if (contentId === 'register-visit-interest-section' && visitIdInput && !visitIdInput.value) {
                    resetVisitForm();
                }
                // Lógica para Sugestões de Imóveis
                else if (contentId === 'property-suggestions-section') {
                    if (clientSuggestionSearchInput) {
                        clientSuggestionSearchInput.value = '';
                    }
                    loadClientsForSuggestionsTable(''); 
                    if (suggestedPropertiesGallery) {
                        suggestedPropertiesGallery.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--color-secondary);">Selecione um cliente acima para ver as sugestões de imóveis.</p>';
                    }
                    if (selectedClientNameForSuggestions) {
                        selectedClientNameForSuggestions.textContent = '';
                    }
                }
                // NOVA LÓGICA PARA VENDAS
                else if (contentId === 'track-sales-section') {
                    loadSalesTable();
                    if (saleSearchInput) {
                        saleSearchInput.value = '';
                    }
                } else if (contentId === 'register-sale-section' && saleIdInput && !saleIdInput.value) {
                    resetSaleForm();
                }
                // Lógica para Logout
                else if (contentId === 'logout-action') {
                    window.location.href = 'login.html'; // Redireciona para a página de login
                    return; // Sai da função para evitar processamento adicional
                }

                            // Lógica para mostrar/ocultar campos específicos do TIPO DE IMÓVEL
            // Re-organizado para ser uma função mais robusta e reutilizável
            const updatePropertyFieldsVisibility = () => {
                const selectedType = tipoImovelSelect ? tipoImovelSelect.value : '';

                allTypeSpecificFieldDivs.forEach(div => {
                    div.style.display = 'none';
                    div.querySelectorAll('input, select, textarea').forEach(input => input.removeAttribute('required'));
                });

                if (typeFieldGroups[selectedType]) {
                    typeFieldGroups[selectedType].forEach(fieldGroupId => {
                        const fieldGroupDiv = document.getElementById(fieldGroupId);
                        if (fieldGroupDiv) {
                            fieldGroupDiv.style.display = 'grid';
                        }
                    });

                    // Set required attributes based on selected type
                    if (selectedType === 'TERRENO') {
                        document.getElementById('topografia').setAttribute('required', 'true');
                    } else if (selectedType === 'CASA' || selectedType === 'APARTAMENTO') {
                        document.getElementById('numero_quartos').setAttribute('required', 'true');
                        document.getElementById('numero_banheiros').setAttribute('required', 'true');
                        document.getElementById('area_construida').setAttribute('required', 'true');
                        if (selectedType === 'CASA') {
                            document.getElementById('numero_pavimentos').setAttribute('required', 'true');
                        } else if (selectedType === 'APARTAMENTO') {
                            document.getElementById('andar').setAttribute('required', 'true');
                            document.getElementById('numero_apartamento').setAttribute('required', 'true');
                        }
                    } else if (selectedType === 'PREDIO_COMERCIAL' || selectedType === 'SALA_COMERCIAL') {
                        document.getElementById('area_util').setAttribute('required', 'true');
                        if (selectedType === 'PREDIO_COMERCIAL') {
                            document.getElementById('total_andares').setAttribute('required', 'true');
                            document.getElementById('numero_salas').setAttribute('required', 'true');
                        } else if (selectedType === 'SALA_COMERCIAL') {
                            document.getElementById('andar_sala').setAttribute('required', 'true');
                            document.getElementById('numero_sala').setAttribute('required', 'true');
                        }
                    }
                }
            };


                // Chamar a função para atualizar visibilidade dos campos de imóvel caso o select esteja presente
                if (tipoImovelSelect) {
                    updatePropertyFieldsVisibility();
                }
                // Chamar a função para popular selects e atualizar visibilidade dos campos de avaliação (para visitas)
                if (imovelVisitaSelect) {
                    populateVisitFormSelects(); 
                    updateAvaliacaoFieldsVisibility();
                }
                // Chamar a função para popular selects da venda
                if (imovelVendaSelect) { // Qualquer um dos selects da venda indica que estamos no contexto de venda
                    populateSaleFormSelects();
                }
            }
        };

        // Comentário: Função assíncrona para popular os selects de cliente, imóvel e corretor no formulário de visita, buscando dados do backend.
            const populateVisitFormSelects = async () => { // Adicionado 'async'
                // Comentário: Popula o Select de Clientes.
                clienteVisitaSelect.innerHTML = '<option value="">Selecione o Cliente</option>';
                try {
                    const clientsResponse = await fetch(`${API_BASE_URL}/clients?active=true`, { // Busca apenas clientes ativos
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    if (clientsResponse.ok) {
                        const clients = await clientsResponse.json();
                        clients.forEach(client => {
                            const option = document.createElement('option');
                            option.value = client.id;
                            option.textContent = `${client.nome} (${client.documentType}: ${client.cpf || client.cnpj})`;
                            clienteVisitaSelect.appendChild(option);
                        });
                    } else {
                        console.error('Erro ao carregar clientes para o select:', await clientsResponse.text());
                    }
                } catch (error) { console.error('Erro de rede ao carregar clientes:', error); }

                // Comentário: Popula o Select de Imóveis.
                imovelVisitaSelect.innerHTML = '<option value="">Selecione o Imóvel</option>';
                try {
                    const propertiesResponse = await fetch(`${API_BASE_URL}/properties?status=DISPONIVEL`, { // Busca apenas imóveis disponíveis
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    if (propertiesResponse.ok) {
                        const properties = await propertiesResponse.json();
                        properties.forEach(property => {
                            const option = document.createElement('option');
                            option.value = property.id;
                            option.textContent = `Mat. ${property.numeroMatriculaImovel} - ${property.endereco?.logradouro || ''}, ${property.endereco?.numero || ''}`;
                            imovelVisitaSelect.appendChild(option);
                        });
                    } else {
                        console.error('Erro ao carregar imóveis para o select:', await propertiesResponse.text());
                    }
                } catch (error) { console.error('Erro de rede ao carregar imóveis:', error); }

                // Comentário: Popula o Select de Corretores (apenas usuários com cargo 'CORRETOR').
                corretorVisitaSelect.innerHTML = '<option value="">Selecione o Corretor</option>';
                try {
                    const corretoresResponse = await fetch(`${API_BASE_URL}/users?tipoCargo=CORRETOR&ativo=true`, { // Busca apenas corretores ativos
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    if (corretoresResponse.ok) {
                        const corretores = await corretoresResponse.json();
                        corretores.forEach(corretor => {
                            const option = document.createElement('option');
                            option.value = corretor.id;
                            option.textContent = `${corretor.nome} (${corretor.documentType}: ${corretor.cpf || corretor.cnpj})`;
                            corretorVisitaSelect.appendChild(option);
                        });
                    } else {
                        console.error('Erro ao carregar corretores para o select:', await corretoresResponse.text());
                    }
                } catch (error) { console.error('Erro de rede ao carregar corretores:', error); }
            };

// Comentário: Função assíncrona para atualizar a visibilidade dos campos de interesse/avaliação.
            // Comentário: Essa função agora buscará os detalhes do imóvel (incluindo seus 'interessesValidos') do backend.
            const updateAvaliacaoFieldsVisibility = async () => { // Adicionado 'async'
                const selectedPropertyId = imovelVisitaSelect ? imovelVisitaSelect.value : '';

                const allInterestFieldGroups = avaliacaoFields.querySelectorAll('.form-group[data-interest-field]');
                allInterestFieldGroups.forEach(group => {
                    group.style.display = 'none';
                    // Comentário: Limpa os radio buttons de avaliação quando a visibilidade é resetada.
                    group.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                });

                if (!selectedPropertyId) { // Se nenhum imóvel for selecionado, oculta tudo.
                    avaliacaoFields.style.display = 'none';
                    avaliacaoImovelTitle.style.display = 'none';
                    avaliacaoImovelDesc.style.display = 'none';
                    return;
                }

                try {
                    // Comentário: Busca os detalhes do imóvel selecionado do backend para obter os 'interessesValidos'.
                    const response = await fetch(`${API_BASE_URL}/properties/${selectedPropertyId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) {
                        // Comentário: Em caso de erro (ex: imóvel não encontrado, sessão expirada), oculta os campos.
                        console.error('Erro ao buscar detalhes do imóvel para avaliação:', await response.text());
                        avaliacaoFields.style.display = 'none';
                        avaliacaoImovelTitle.style.display = 'none';
                        avaliacaoImovelDesc.style.display = 'none';
                        return;
                    }

                    const selectedProperty = await response.json(); // Obtém o objeto do imóvel do backend.

                    // Comentário: Agora, usa os 'interessesValidos' que vieram do backend.
                    if (selectedProperty && selectedProperty.interessesValidos && selectedProperty.interessesValidos.length > 0) {
                        avaliacaoFields.style.display = 'grid';
                        avaliacaoImovelTitle.style.display = 'block';
                        avaliacaoImovelDesc.style.display = 'block';

                        selectedProperty.interessesValidos.forEach(fieldName => {
                            const fieldGroup = avaliacaoFields.querySelector(`.form-group[data-interest-field="${fieldName}"]`);
                            if (fieldGroup) {
                                fieldGroup.style.display = 'block';
                            }
                        });
                    } else {
                        // Comentário: Se o imóvel não tiver interesses válidos configurados, oculta os campos.
                        avaliacaoFields.style.display = 'none';
                        avaliacaoImovelTitle.style.display = 'none';
                        avaliacaoImovelDesc.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Erro de rede ao buscar detalhes do imóvel para avaliação:', error);
                    avaliacaoFields.style.display = 'none';
                    avaliacaoImovelTitle.style.display = 'none';
                    avaliacaoImovelDesc.style.display = 'none';
                }
            };
        
            // Comentário: Função assíncrona para popular os selects de imóvel, cliente comprador e corretor no formulário de venda.
            const populateSaleFormSelects = async () => { // Adicionado 'async'
                // Comentário: Popula o Select de Imóveis.
                imovelVendaSelect.innerHTML = '<option value="">Selecione o Imóvel</option>';
                try {
                    const propertiesResponse = await fetch(`${API_BASE_URL}/properties?status=DISPONIVEL`, { // Busca apenas imóveis disponíveis
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    if (propertiesResponse.ok) {
                        const properties = await propertiesResponse.json();
                        properties.forEach(property => {
                            const option = document.createElement('option');
                            option.value = property.id;
                            option.textContent = `Mat. ${property.numeroMatriculaImovel} - ${property.endereco?.logradouro || ''}, ${property.endereco?.numero || ''}`;
                            option.dataset.proprietarioId = property.proprietario?.id; // Armazena o ID do proprietário no data attribute
                            imovelVendaSelect.appendChild(option);
                        });
                    } else {
                        console.error('Erro ao carregar imóveis para o select:', await propertiesResponse.text());
                    }
                } catch (error) { console.error('Erro de rede ao carregar imóveis:', error); }

                // Comentário: Popula o Select de Cliente Comprador.
                clienteCompradorSelect.innerHTML = '<option value="">Selecione o Comprador</option>';
                try {
                    const clientsResponse = await fetch(`${API_BASE_URL}/clients?active=true`, { // Busca apenas clientes ativos
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    if (clientsResponse.ok) {
                        const clients = await clientsResponse.json();
                        clients.forEach(client => {
                            const option = document.createElement('option');
                            option.value = client.id;
                            option.textContent = `${client.nome} (${client.documentType}: ${client.cpf || client.cnpj})`;
                            clienteCompradorSelect.appendChild(option);
                        });
                    } else {
                        console.error('Erro ao carregar clientes para o select:', await clientsResponse.text());
                    }
                } catch (error) { console.error('Erro de rede ao carregar clientes:', error); }

                // Comentário: Popula o Select de Corretor Responsável.
                corretorVendaSelect.innerHTML = '<option value="">Selecione o Corretor</option>';
                try {
                    const corretoresResponse = await fetch(`${API_BASE_URL}/users?tipoCargo=CORRETOR&ativo=true`, { // Busca apenas corretores ativos
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    if (corretoresResponse.ok) {
                        const corretores = await corretoresResponse.json();
                        corretores.forEach(corretor => {
                            const option = document.createElement('option');
                            option.value = corretor.id;
                            option.textContent = `${corretor.nome} (${corretor.documentType}: ${corretor.cpf || corretor.cnpj})`;
                            corretorVendaSelect.appendChild(option);
                        });
                    } else {
                        console.error('Erro ao carregar corretores para o select:', await corretoresResponse.text());
                    }
                } catch (error) { console.error('Erro de rede ao carregar corretores:', error); }

                // Comentário: Event Listener para preencher Proprietário automaticamente com base no imóvel selecionado.
                imovelVendaSelect.addEventListener('change', async () => { // Adicionado 'async'
                    const selectedPropertyId = imovelVendaSelect.value;
                    proprietarioImovelVendaSelect.innerHTML = '<option value="">Proprietário (automático)</option>'; // Limpa e adiciona opção padrão
                    if (selectedPropertyId) {
                        // Comentário: Se o ID do proprietário foi armazenado no data attribute, usa ele.
                        const proprietarioId = imovelVendaSelect.options[imovelVendaSelect.selectedIndex].dataset.proprietarioId;
                        if (proprietarioId) {
                            try {
                                const ownerResponse = await fetch(`${API_BASE_URL}/clients/${proprietarioId}`, { // Busca os dados do proprietário por ID
                                    headers: { 'Authorization': `Bearer ${getToken()}` }
                                });
                                if (ownerResponse.ok) {
                                    const owner = await ownerResponse.json();
                                    const option = document.createElement('option');
                                    option.value = owner.id;
                                    option.textContent = `${owner.nome} (${owner.documentType}: ${owner.cpf || owner.cnpj})`;
                                    option.selected = true; // Seleciona automaticamente
                                    proprietarioImovelVendaSelect.appendChild(option);
                                } else {
                                    console.error('Erro ao carregar proprietário para o select:', await ownerResponse.text());
                                }
                            } catch (error) { console.error('Erro de rede ao carregar proprietário:', error); }
                        }
                    }
                });
            };


        // Comentário: Funções auxiliares para formatação de CPF/CNPJ
        const formatCpf = (value) => {
            value = value.replace(/\D/g, ""); // Remove tudo que não é dígito
            value = value.replace(/(\d{3})(\d)/, "$1.$2"); // Coloca ponto entre o terceiro e o quarto dígitos
            value = value.replace(/(\d{3})(\d)/, "$1.$2"); // Coloca ponto entre o sexto e o sétimo dígitos
            value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2"); // Coloca hífen entre o nono e o décimo dígitos
            return value;
        };

        const formatCnpj = (value) => {
            value = value.replace(/\D/g, ""); // Remove tudo que não é dígito
            value = value.replace(/^(\d{2})(\d)/, "$1.$2"); // Coloca ponto entre o segundo e o terceiro dígitos
            value = value.replace(/^(\d{2}).(\d{3})(\d)/, "$1.$2.$3"); // Coloca ponto entre o quinto e o sexto dígitos
            value = value.replace(/.(\d{3})(\d)/, ".$1/$2"); // Coloca barra entre o oitavo e o nono dígitos
            value = value.replace(/(\d{4})(\d)/, "$1-$2"); // Coloca hífen depois dos quatro primeiros dígitos (antes do final)
            return value;
        };

        const unformatDocument = (value) => {
            return value.replace(/\D/g, ""); // Remove todos os caracteres não numéricos
        };

        document.addEventListener('DOMContentLoaded', () => {
            const usersTableBody = document.getElementById('users-table-body');
            const userSearchInput = document.getElementById('user-search-input'); 

            // Elements for user registration/edit form
            const userFormTitle = document.getElementById('user-form-title');
            const userFormDescription = document.getElementById('user-form-description');
            const userIdInput = document.getElementById('user_id');
            const saveUserBtn = document.getElementById('save-user-btn');
            const deleteUserBtn = document.getElementById('delete-user-btn');
            const userRegistrationForm = document.getElementById('user-registration-form');

            // Elements for client list/edit
            const clientsTableBody = document.getElementById('clients-table-body');
            const clientSearchInput = document.getElementById('client-search-input');
            const clientFormTitle = document.getElementById('client-form-title');
            const clientFormDescription = document.getElementById('client-form-description');
            const clientIdInput = document.getElementById('client_id');
            const saveClientBtn = document.getElementById('save-client-btn');
            const deleteClientBtn = document.getElementById('delete-client-btn');
            const clientRegistrationForm = document.getElementById('client-registration-form');

            // Elements for property list/edit
            const propertiesTableBody = document.getElementById('properties-table-body');
            const propertySearchInput = document.getElementById('property-search-input');
            const propertyFormTitle = document.getElementById('property-form-title');
            const propertyFormDescription = document.getElementById('property-form-description');
            const propertyIdInput = document.getElementById('property_id');
            const savePropertyBtn = document.getElementById('save-property-btn');
            const deletePropertyBtn = document.getElementById('delete-property-btn');
            const propertyRegistrationForm = document.getElementById('property-registration-form');
            const tipoImovelSelect = document.getElementById('tipo_imovel_select'); 
            const allTypeSpecificFieldDivs = document.querySelectorAll('.type-specific-fields'); 

            // Elements for visit/interest management
            const visitsTableBody = document.getElementById('visits-table-body'); 
            const visitSearchInput = document.getElementById('visit-search-input'); 
            const visitFormTitle = document.getElementById('visit-form-title'); 
            const visitFormDescription = document.getElementById('visit-form-description'); 
            const visitIdInput = document.getElementById('visit_id'); 
            const saveVisitBtn = document.getElementById('save-visit-btn'); 
            const deleteVisitBtn = document.getElementById('delete-visit-btn'); 
            const visitRegistrationForm = document.getElementById('visit-registration-form'); 

            const clienteVisitaSelect = document.getElementById('cliente_visita_select'); 
            const imovelVisitaSelect = document.getElementById('imovel_visita_select'); 
            const corretorVisitaSelect = document.getElementById('corretor_visita_select'); 
            const avaliacaoFields = document.getElementById('avaliacao_fields'); 
            const avaliacaoImovelTitle = document.getElementById('avaliacao_imovel_title'); 
            const avaliacaoImovelDesc = document.getElementById('avaliacao_imovel_desc'); 

            // Elements for property suggestions
            const clientSuggestionSearchInput = document.getElementById('client-suggestion-search-input'); 
            const clientsForSuggestionTableBody = document.getElementById('clients-for-suggestion-table-body');
            const selectedClientNameForSuggestions = document.getElementById('selected-client-name-for-suggestions');
            const suggestedPropertiesGallery = document.getElementById('suggested-properties-gallery');

            // Elements for sales management (NOVOS)
            const salesTableBody = document.getElementById('sales-table-body');
            const saleSearchInput = document.getElementById('sale-search-input');
            const saleFormTitle = document.getElementById('sale-form-title');
            const saleFormDescription = document.getElementById('sale-form-description');
            const saleIdInput = document.getElementById('sale_id');
            const saveSaleBtn = document.getElementById('save-sale-btn');
            const deleteSaleBtn = document.getElementById('delete-sale-btn');
            const saleRegistrationForm = document.getElementById('sale-registration-form');

            const imovelVendaSelect = document.getElementById('imovel_venda_select');
            const clienteCompradorSelect = document.getElementById('cliente_comprador_select');
            const proprietarioImovelVendaSelect = document.getElementById('proprietario_imovel_venda_select');
            const corretorVendaSelect = document.getElementById('corretor_venda_select');

            // Comentário: Função assíncrona para buscar as estatísticas do dashboard do backend.
            const loadDashboardStats = async () => {
                try {
                    // Comentário: Faz uma requisição GET para o endpoint que retorna o total de usuários.
                    // Comentário: O Spring Boot precisará expor um endpoint como '/api/dashboard/users/count' que retorna um número inteiro.
                    const usersCountResponse = await fetch(`${API_BASE_URL}/dashboard/users/count`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` } // Envia o token de autenticação
                    });
                    const usersCount = await usersCountResponse.json(); // Espera que a resposta seja um número JSON.
                    document.getElementById('stat-total-users').textContent = usersCount; // Atualiza o elemento HTML.

                    // Comentário: Repita o padrão para os outros contadores do dashboard.
                    // Comentário: Certifique-se de que seus endpoints no Spring Boot retornem apenas o número esperado.
                    const clientsCountResponse = await fetch(`${API_BASE_URL}/dashboard/clients/count`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const clientsCount = await clientsCountResponse.json();
                    document.getElementById('stat-total-clients').textContent = clientsCount;

                    const propertiesCountResponse = await fetch(`${API_BASE_URL}/dashboard/properties/count`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const propertiesCount = await propertiesCountResponse.json();
                    document.getElementById('stat-total-properties').textContent = propertiesCount;

                    const salesCountResponse = await fetch(`${API_BASE_URL}/dashboard/sales/count`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const salesCount = await salesCountResponse.json();
                    document.getElementById('stat-total-sales').textContent = salesCount;

                    const visitsTodayResponse = await fetch(`${API_BASE_URL}/dashboard/visits/countToday`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const visitsToday = await visitsTodayResponse.json();
                    document.getElementById('stat-visits-today').textContent = visitsToday;

                    const interests7DaysResponse = await fetch(`${API_BASE_URL}/dashboard/interests/countLast7Days`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const interests7Days = await interests7DaysResponse.json();
                    document.getElementById('stat-interests-7days').textContent = interests7Days;

                } catch (error) {
                    // Comentário: Em caso de erro, exibe mensagens no console e alerta o usuário.
                    console.error('Erro ao carregar estatísticas do dashboard:', error);
                    alert('Erro ao carregar dados do dashboard.');
                    // Comentário: Considerar limpar o token e redirecionar para o login se o erro for 401/403.
                    if (error.message.includes('Sessão expirada') || error.message.includes('não autorizado')) {
                        removeToken();
                        window.location.href = 'login.html';
                    }
                }
            };

            

            // Anexar event listeners aos links da barra lateral
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault(); // Impede o comportamento padrão do link
                    const contentId = link.dataset.contentId || link.getAttribute('href').substring(1);
                    // Se o link for de logout, redireciona diretamente
                    if (contentId === 'logout-action' || link.getAttribute('href') === 'login.html') {
                        window.location.href = 'login.html';
                    } else {
                        showSection(contentId);
                    }
                });
            });

            // Anexar event listeners aos action-cards do dashboard
            const actionCards = document.querySelectorAll('.dashboard-stats .action-card');
            actionCards.forEach(card => {
                card.addEventListener('click', (event) => {
                    event.preventDefault(); // Impede o comportamento padrão do link
                    const contentId = card.dataset.contentId || card.getAttribute('href').substring(1);
                    showSection(contentId);
                });
            });


            // USER FUNCTIONS -----------------------------------------------------------

            // Comentário: Função assíncrona para carregar e exibir os usuários na tabela a partir do backend.
            const loadUsersTable = async (searchTerm = '') => {
                // Comentário: Exibe uma mensagem de carregamento enquanto os dados são buscados.
                usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando usuários...</td></tr>'; 

                try {
                    // Comentário: Realiza uma requisição GET para o endpoint de listagem de usuários do seu backend Spring Boot.
                    // Comentário: O termo de pesquisa é enviado como um parâmetro de query string, e o token JWT é incluído no cabeçalho 'Authorization'.
                    const response = await fetch(`${API_BASE_URL}/users?search=${encodeURIComponent(searchTerm)}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Envia o token de autenticação
                        }
                    });

                    // Comentário: Verifica se a resposta da requisição foi bem-sucedida (status 2xx).
                    if (!response.ok) {
                        // Comentário: Lida com respostas de erro comuns de autenticação/autorização.
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken(); // Limpa o token inválido
                            window.location.href = 'login.html'; // Redireciona para o login
                            return;
                        }
                        const errorData = await response.json(); // Tenta ler o corpo da resposta como JSON de erro.
                        throw new Error(errorData.message || 'Erro ao carregar usuários.');
                    }

                    const users = await response.json(); // Converte a resposta JSON para um array de objetos JavaScript.

                    usersTableBody.innerHTML = ''; // Limpa o conteúdo atual da tabela.

                    // Comentário: Se nenhum usuário for retornado, exibe uma mensagem indicando isso.
                    if (users.length === 0) {
                        usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--color-secondary);">Nenhum usuário encontrado.</td></tr>'; 
                        return;
                    }

                    // Comentário: Itera sobre o array de usuários recebido do backend para popular as linhas da tabela.
                    users.forEach(user => { 
                        const row = usersTableBody.insertRow();
                        // Comentário: Acessa propriedades como 'nome', 'primaryKey', 'ativo', 'tipoCargo' que devem vir do backend.
                        const primaryKey = user.documentType === 'CPF' ? user.cpf : user.cnpj;
                        const cleanId = primaryKey.replace(/\//g, '');
                        const userId= `${user.documentType}${cleanId}`;
                        row.innerHTML = `
                            <td data-label="Nome">${user.nome}</td>
                            <td data-label="Chave Primária">${user.primaryKey || user.cpf || user.cnpj || 'N/A'}</td>
                            <td data-label="Status">${user.ativo ? 'Ativo' : 'Inativo'}</td>
                            <td data-label="Cargo">${user.tipoCargo}</td>
                            <td data-label="Ações" class="actions-cell">
                                <button class="edit-btn" data-user-id="${userId}"><i class="fas fa-edit"></i></button>
                            </td>
                        `;
                    });

                    // Comentário: Adiciona event listeners aos botões de edição após a tabela ser preenchida dinamicamente.
                    document.querySelectorAll('#users-table-body .edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const userId = event.currentTarget.dataset.userId;
                            editUser(userId); // Chama a função 'editUser' com o ID do usuário clicado.
                        });
                    });

                } catch (error) {
                    // Comentário: Captura e exibe erros que podem ocorrer durante a requisição ou processamento.
                    console.error('Erro ao buscar usuários:', error);
                    usersTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--color-error);">Erro ao carregar usuários: ${error.message}</td></tr>`; 
                }
            };

            // Comentário: Adiciona um event listener ao campo de pesquisa. Sempre que o usuário digita, a tabela é recarregada com o termo de pesquisa.
            if (userSearchInput) { //
                userSearchInput.addEventListener('keyup', (event) => { //
                    loadUsersTable(event.target.value); //
                }); //
            } 

            // Comentário: Função assíncrona para carregar os dados de um usuário específico para edição.
            const editUser = async (userId) => { // Adicionado 'async'
                try {
                    // Comentário: Faz uma requisição GET para o endpoint de detalhe de usuário do Spring Boot.
                    const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        }
                    });

                    // Comentário: Verifica a resposta e trata erros.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Usuário não encontrado.');
                    }

                    const user = await response.json(); // Converte a resposta JSON para um objeto JavaScript.

                    // Comentário: Atualiza o título e descrição do formulário para modo de edição.
                    userFormTitle.textContent = 'Editar Usuário'; 
                    userFormDescription.textContent = 'Modifique os campos abaixo para atualizar o cadastro do usuário.'; 
                    userIdInput.value = userId; // Define o ID do usuário no campo hidden.

                    // Comentário: Preenche os campos do formulário com os dados recebidos do backend.
                    // Comentário: Dispara eventos 'change' para garantir que a lógica de visibilidade de campos (CPF/CNPJ, Área de Atuação) seja atualizada.
                    document.getElementById('cpf_cnpj_select_user').value = user.documentType || '';
                    document.getElementById('cpf_cnpj_select_user').dispatchEvent(new Event('change'));
                    document.getElementById('cpf_user').value = user.cpf ? formatCpf(user.cpf) : '';
                    document.getElementById('cnpj_user').value = user.cnpj ? formatCnpj(user.cnpj) : '';
                    document.getElementById('nome_user').value = user.nome || '';
                    document.getElementById('email_user').value = user.email || '';
                    document.getElementById('telefone_user').value = user.telefone || '';
                    document.getElementById('cep_user').value = user.endereco?.cep || ''; // Acessa sub-propriedade 'endereco.cep'
                    document.getElementById('logradouro_user').value = user.endereco?.logradouro || '';
                    document.getElementById('numero_user').value = user.endereco?.numero || '';
                    document.getElementById('complemento_user').value = user.endereco?.complemento || '';
                    document.getElementById('bairro_user').value = user.endereco?.bairro || '';
                    document.getElementById('cidade_user').value = user.endereco?.cidade || '';
                    document.getElementById('estado_user').value = user.endereco?.estado || '';
                    document.getElementById('tipo_cargo').value = user.tipoCargo || ''; // 'tipoCargo' deve ser o nome da propriedade no backend
                    document.getElementById('tipo_cargo').dispatchEvent(new Event('change'));
                    document.getElementById('area_atuacao').value = user.areaAtuacao || '';
                    document.getElementById('senha').value = ''; // Senha geralmente não é pré-preenchida por segurança.
                    document.getElementById('confirmar_senha').value = '';
                    document.getElementById('ativo').checked = user.ativo; // 'ativo' deve ser um booleano do backend.

                    // Comentário: Torna o botão de exclusão visível e atribui a ele a função 'deleteUser'.
                    deleteUserBtn.style.display = 'inline-block';
                    deleteUserBtn.onclick = () => deleteUser(userId);

                    showSection('register-user-section'); // Exibe a seção do formulário de registro/edição.

                } catch (error) {
                    console.error('Erro ao carregar usuário para edição:', error);
                    alert(`Erro ao carregar usuário: ${error.message}`);
                }
            };

            const resetUserForm = () => {
                userFormTitle.textContent = 'Cadastrar Novo Usuário';
                userFormDescription.textContent = 'Preencha os campos abaixo para registrar um novo usuário no sistema.';
                userIdInput.value = '';
                userRegistrationForm.reset();
                document.getElementById('cpf_cnpj_select_user').dispatchEvent(new Event('change'));
                document.getElementById('tipo_cargo').dispatchEvent(new Event('change'));
                deleteUserBtn.style.display = 'none';
            };


            // Comentário: Event listener para a submissão do formulário de cadastro/edição de usuário.
           userRegistrationForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const formData = new FormData(userRegistrationForm);
                const userData = Object.fromEntries(formData.entries());

                // Desformatar CPF/CNPJ antes de criar clientToSend
                if (userData.documentType === 'CPF' && userData.cpf) {
                    userData.cpf = unformatDocument(userData.cpf);
                }
                if (userData.documentType === 'CNPJ' && userData.cnpj) {
                    userData.cnpj = unformatDocument(userData.cnpj);
                }

                // Comentário: Reorganiza os dados para corresponder à estrutura de um DTO de cliente no Spring.
                const userToSend = {
                    id: userData.userId || null,
                    nome: userData.nome,
                    email: userData.email,
                    telefone: userData.telefone,
                    documentType: userData.documentType,
                    cpf: userData.cpf,
                    cnpj: userData.cnpj,
                    endereco: userData.logradouro, // logradouro vira 'endereco'
                    bairro: userData.bairro,
                    cidade: userData.cidade,
                    complemento: userData.complemento,
                    estado: userData.estado,
                    cep: userData.cep,
                    tipoCargo: userData.tipoCargo,
                    areaAtuacao: userData.areaAtuacao,
                    ativo: userData.ativo,
                    numero: userData.numero,
                    senha: userData.senha // Inclua se o backend espera esse campo para cadastro/edição
                };

                userToSend.ativo = userToSend.ativo === "on";

                // Comentário: Determina o método HTTP (POST para novo usuário, PUT para edição) e a URL do endpoint.
                const isEditing = !!userIdInput.value; // Verifica se há um ID de usuário, indicando edição.
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${API_BASE_URL}/users/${userIdInput.value}` : `${API_BASE_URL}/users`;

                try {
                    // Comentário: Envia os dados do usuário para o backend.
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        },
                        // Comentário: Converte o objeto userData para JSON. Remova 'confirmarSenha' antes de enviar, pois não é uma propriedade do modelo de backend.
                        body: JSON.stringify(userToSend) 
                    });

                    // Comentário: Verifica se a operação no backend foi bem-sucedida.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} usuário.`);
                    }

                    // Comentário: Mensagem de sucesso e redirecionamento para a lista de usuários.
                    alert(`Usuário ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
                    resetUserForm(); // Limpa o formulário
                    showSection('list-manage-users-content'); // Volta para a lista
                } catch (error) {
                    // Comentário: Captura e exibe erros da requisição.
                    console.error(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} usuário:`, error);
                    alert(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} usuário: ${error.message}`);
                }
            });

            // Comentário: Função assíncrona para excluir um usuário do backend.
            const deleteUser = async (userId) => { // Adicionado 'async'
                // Comentário: Confirmação antes de prosseguir com a exclusão.
                if (confirm('Tem certeza que deseja excluir este usuário? Esta ação é irreversível.')) {
                    try {
                        // Comentário: Envia uma requisição DELETE para o endpoint de exclusão de usuário do Spring Boot.
                        const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                            }
                        });

                        // Comentário: Verifica se a exclusão foi bem-sucedida (status 204 No Content ou 200 OK).
                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) {
                                alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                                removeToken();
                                window.location.href = 'login.html';
                                return;
                            }
                            // Comentário: Se houver um corpo de erro, tenta lê-lo.
                            const errorData = response.status !== 204 ? await response.json() : { message: 'Erro desconhecido.' };
                            throw new Error(errorData.message || 'Erro ao excluir usuário.');
                        }

                        // Comentário: Mensagem de sucesso e recarregamento da lista de usuários.
                        alert('Usuário excluído com sucesso!');
                        resetUserForm(); // Limpa o formulário
                        showSection('list-manage-users-content'); // Volta para a lista de usuários
                    } catch (error) {
                        // Comentário: Captura e exibe erros da requisição de exclusão.
                        console.error('Erro ao excluir usuário:', error);
                        alert(`Erro ao excluir usuário: ${error.message}`);
                    }
                }
            };

            // CLIENT FUNCTIONS -----------------------------------------------------------

            const toggleCpfCnpjClientFields = () => {
                const cpfCnpjSelectClient = document.getElementById('cpf_cnpj_select_client');
                const cpfGroupClient = document.getElementById('cpf_group_client');
                const cnpjGroupClient = document.getElementById('cnpj_group_client');
                const cpfInputClient = document.getElementById('cpf_client');
                const cnpjInputClient = document.getElementById('cnpj_client');

                if (cpfCnpjSelectClient && cpfCnpjSelectClient.value === 'CPF') {
                    cpfGroupClient.style.display = 'block';
                    cnpjGroupClient.style.display = 'none';
                    cpfInputClient.setAttribute('required', 'true');
                    cnpjInputClient.removeAttribute('required');
                    cnpjInputClient.value = '';
                } else if (cpfCnpjSelectClient && cpfCnpjSelectClient.value === 'CNPJ') {
                    cpfGroupClient.style.display = 'none';
                    cnpjGroupClient.style.display = 'block';
                    cnpjInputClient.setAttribute('required', 'true');
                    cpfInputClient.removeAttribute('required');
                    cpfInputClient.value = '';
                } else {
                    cpfGroupClient.style.display = 'none';
                    cnpjGroupClient.style.display = 'none';
                    cpfInputClient.removeAttribute('required');
                    cnpjInputClient.removeAttribute('required');
                    cpfInputClient.value = '';
                    cnpjInputClient.value = '';
                }
            };

            if (document.getElementById('cpf_cnpj_select_client')) {
                document.getElementById('cpf_cnpj_select_client').addEventListener('change', toggleCpfCnpjClientFields);
                toggleCpfCnpjClientFields();
            }

            // Comentário: Função assíncrona para carregar e exibir os clientes na tabela a partir do backend.
            const loadClientsTable = async (searchTerm = '') => { // Adicionado 'async'
                clientsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Carregando clientes...</td></tr>';

                try {
                    // Comentário: Faz uma requisição GET para o endpoint de listagem de clientes do Spring Boot.
                    // Comentário: O termo de pesquisa é enviado como um parâmetro de query string, e o token JWT é incluído no cabeçalho.
                    const response = await fetch(`${API_BASE_URL}/clients?search=${encodeURIComponent(searchTerm)}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao carregar clientes.');
                    }

                    const clients = await response.json(); // Converte a resposta JSON para um array de objetos JavaScript.

                    clientsTableBody.innerHTML = '';

                    if (clients.length === 0) {
                        clientsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-secondary);">Nenhum cliente encontrado.</td></tr>';
                        return;
                    }

                    clients.forEach(client => {
                        const row = clientsTableBody.insertRow();
                        // Comentário: Ajuste para primaryKey, que pode ser cpf ou cnpj no seu backend.
                        const primaryKeyValue = client.documentType === 'CPF' ? client.cpf : client.cnpj;
                        const cleanId = primaryKeyValue.replace(/\//g, '');
                        const clientId = `${client.documentType}${cleanId}`;
                        row.innerHTML = `
                            <td data-label="Nome">${client.nome}</td>
                            <td data-label="Chave Primária">${primaryKeyValue || 'N/A'}</td>
                            <td data-label="Email">${client.email || 'N/A'}</td>
                            <td data-label="Telefone">${client.telefone || 'N/A'}</td>
                            <td data-label="Data de Cadastro">${client.dataCadastro || 'N/A'}</td>
                            <td data-label="Ações" class="actions-cell">
                                <button class="edit-btn" data-client-id="${clientId}"><i class="fas fa-edit"></i></button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('#clients-table-body .edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const clientId = event.currentTarget.dataset.clientId;
                            editClient(clientId);
                        });
                    });

                } catch (error) {
                    console.error('Erro ao buscar clientes:', error);
                    clientsTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--color-error);">Erro ao carregar clientes: ${error.message}</td></tr>`;
                }
            };

            if (clientSearchInput) {
                clientSearchInput.addEventListener('keyup', (event) => {
                    loadClientsTable(event.target.value);
                });
            }

            // Comentário: Função assíncrona para carregar os dados de um cliente específico para edição.
            const editClient = async (clientId) => { // Adicionado 'async'
                try {
                    // Comentário: Faz uma requisição GET para o endpoint de detalhe de cliente do Spring Boot.
                    const response = await fetch(`${API_BASE_URL}/clients/${clientId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        }
                    });

                    // Comentário: Verifica a resposta e trata erros.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Cliente não encontrado.');
                    }

                    const client = await response.json(); // Converte a resposta JSON para um objeto JavaScript.

                    // Comentário: Atualiza o título e descrição do formulário para modo de edição.
                    clientFormTitle.textContent = 'Editar Cliente';
                    clientFormDescription.textContent = 'Modifique os campos abaixo para atualizar o cadastro do cliente.';
                    clientIdInput.value = clientId; // Define o ID do cliente no campo hidden.

                    // Comentário: Preenche os campos do formulário com os dados recebidos do backend.
                    // Comentário: Dispara eventos 'change' para garantir que a lógica de visibilidade de campos (CPF/CNPJ) seja atualizada.
                    document.getElementById('cpf_cnpj_select_client').value = client.documentType || '';
                    document.getElementById('cpf_cnpj_select_client').dispatchEvent(new Event('change'));
                    document.getElementById('cpf_client').value = client.cpf ? formatCpf(client.cpf) : '';
                    document.getElementById('cnpj_client').value = client.cnpj ? formatCnpj(client.cnpj) : '';
                    document.getElementById('nome_client').value = client.nome || '';
                    document.getElementById('email_client').value = client.email || '';
                    document.getElementById('telefone_client').value = client.telefone || '';
                    document.getElementById('cep_client').value = client.cep || '';
                    document.getElementById('logradouro_client').value = client.endereco || '';
                    document.getElementById('numero_client').value = client.numero || '';
                    document.getElementById('complemento_client').value = client.complemento || '';
                    document.getElementById('bairro_client').value = client.bairro || '';
                    document.getElementById('cidade_client').value = client.cidade || '';
                    document.getElementById('estado_client').value = client.estado || '';
                    document.getElementById('data_cadastro_client').value = client.dataCadastro || ''; // Ajuste para formato de data
                    
                    // Comentário: Torna o botão de exclusão visível e atribui a ele a função 'deleteClient'.
                    deleteClientBtn.style.display = 'inline-block';
                    deleteClientBtn.onclick = () => deleteClient(clientId);

                    showSection('register-client-section'); // Exibe a seção do formulário de registro/edição.

                } catch (error) {
                    console.error('Erro ao carregar cliente para edição:', error);
                    alert(`Erro ao carregar cliente: ${error.message}`);
                }
            };

            const resetClientForm = () => {
                clientFormTitle.textContent = 'Cadastrar Novo Cliente';
                clientFormDescription.textContent = 'Preencha os campos abaixo para registrar um novo cliente no sistema.';
                clientIdInput.value = '';
                clientRegistrationForm.reset();
                document.getElementById('cpf_cnpj_select_client').dispatchEvent(new Event('change'));
                deleteClientBtn.style.display = 'none';
            };

            // Comentário: Event listener para a submissão do formulário de cadastro/edição de cliente.
            clientRegistrationForm.addEventListener('submit', async (event) => { // Adicionado 'async'
                event.preventDefault();

                const formData = new FormData(clientRegistrationForm);
                const clientData = Object.fromEntries(formData.entries()); // Converte os dados do formulário em um objeto JavaScript.

                // Comentário: Reorganiza os dados para corresponder à estrutura de um DTO de cliente no Spring.
                const clientToSend = {
                    id: clientData.clientId || null, // Se for edição, o ID já estará presente
                    nome: clientData.nome,
                    email: clientData.email,
                    telefone: clientData.telefone,
                    documentType: clientData.documentType,
                    cpf: clientData.cpf,
                    cnpj: clientData.cnpj,
                    dataCadastro: clientData.dataCadastro,
                    cep: clientData.cep,
                    endereco: clientData.logradouro,
                    numero: clientData.numero,
                    complemento: clientData.complemento,
                    bairro: clientData.bairro,
                    cidade: clientData.cidade,
                    estado: clientData.estado
                    
                };

                // Comentário: Determina o método HTTP (POST para novo, PUT para edição) e a URL do endpoint.
                const isEditing = !!clientIdInput.value;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${API_BASE_URL}/clients/${clientIdInput.value}` : `${API_BASE_URL}/clients`;

                try {
                    // Comentário: Envia os dados do cliente para o backend.
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        },
                        body: JSON.stringify(clientToSend) // Converte o objeto cliente para JSON.
                    });

                    // Comentário: Verifica se a operação no backend foi bem-sucedida.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} cliente.`);
                    }

                    // Comentário: Mensagem de sucesso e redirecionamento.
                    alert(`Cliente ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
                    resetClientForm();
                    //showSection('list-manage-clients-content');
                } catch (error) {
                    console.error(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} cliente:`, error);
                    alert(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} cliente: ${error.message}`);
                }
            });

// Comentário: Função assíncrona para excluir um cliente do backend.
            const deleteClient = async (clientId) => { // Adicionado 'async'
                if (confirm('Tem certeza que deseja excluir este cliente? Esta ação é irreversível.')) {
                    try {
                        // Comentário: Envia uma requisição DELETE para o endpoint de exclusão de cliente do Spring Boot.
                        const response = await fetch(`${API_BASE_URL}/clients/${clientId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                            }
                        });

                        // Comentário: Verifica se a exclusão foi bem-sucedida.
                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) {
                                alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                                removeToken();
                                window.location.href = 'login.html';
                                return;
                            }
                            const errorData = response.status !== 204 ? await response.json() : { message: 'Erro desconhecido.' };
                            throw new Error(errorData.message || 'Erro ao excluir cliente.');
                        }

                        // Comentário: Mensagem de sucesso e recarregamento da lista de clientes.
                        alert('Cliente excluído com sucesso!');
                        resetClientForm();
                        showSection('list-manage-clients-content');
                    } catch (error) {
                        console.error('Erro ao excluir cliente:', error);
                        alert(`Erro ao excluir cliente: ${error.message}`);
                    }
                }
            };

            // PROPERTY FUNCTIONS -----------------------------------------------------------


            // Comentário: Função assíncrona para carregar e exibir os imóveis na tabela a partir do backend.
            const loadPropertiesTable = async (searchTerm = '') => { // Adicionado 'async'
                propertiesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Carregando imóveis...</td></tr>';

                try {
                    // Comentário: Faz uma requisição GET para o endpoint de listagem de imóveis do Spring Boot.
                    // Comentário: O termo de pesquisa é enviado como um parâmetro de query string. O backend deve filtrar por matrícula, endereço, finalidade, etc.
                    const response = await fetch(`${API_BASE_URL}/properties?search=${encodeURIComponent(searchTerm)}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao carregar imóveis.');
                    }

                    const properties = await response.json(); // Converte a resposta JSON para um array de objetos JavaScript.

                    propertiesTableBody.innerHTML = '';

                    if (properties.length === 0) {
                        propertiesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-secondary);">Nenhum imóvel encontrado.</td></tr>';
                        return;
                    }

                    properties.forEach(property => {
                        // Comentário: Assume que o objeto 'property' vindo do backend já inclui informações do proprietário (ex: 'proprietario.nome').
                        // Comentário: Ou que o backend retorna o ID do proprietário e você faz uma busca local/cacheada.
                        // Comentário: Idealmente, o backend já "joinaria" essas informações para o frontend.
                        const ownerName = property.nomeProprietario; // Acessa a propriedade 'nome' dentro de 'proprietario'

                        const row = propertiesTableBody.insertRow();
                        row.innerHTML = `
                            <td data-label="Matrícula">${property.numeroMatriculaImovel || 'N/A'}</td>
                            <td data-label="Endereço">${property.endereco || ''}, ${property.numero || ''} - ${property.bairro || ''}, ${property.cidade || ''}/${property.estado || ''}</td>
                            <td data-label="Finalidade">${property.finalidade || 'N/A'}</td>
                            <td data-label="Valor">R$ ${property.valor ? property.valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".") : '0,00'}</td>
                            <td data-label="Status">${property.status || 'N/A'}</td>
                            <td data-label="Proprietário">${ownerName}</td>
                            <td data-label="Ações" class="actions-cell">
                                <button class="edit-btn" data-property-id="${property.id}"><i class="fas fa-edit"></i></button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('#properties-table-body .edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const propertyId = event.currentTarget.dataset.propertyId;
                            editProperty(propertyId);
                        });
                    });

                } catch (error) {
                    console.error('Erro ao buscar imóveis:', error);
                    propertiesTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--color-error);">Erro ao carregar imóveis: ${error.message}</td></tr>`;
                }
            };

            if (propertySearchInput) {
                propertySearchInput.addEventListener('keyup', (event) => {
                    loadPropertiesTable(event.target.value);
                });
            }

// Comentário: Função assíncrona para carregar os dados de um imóvel específico para edição.
            const editProperty = async (propertyId) => { // Adicionado 'async'
                try {
                    // Comentário: Faz uma requisição GET para o endpoint de detalhe de imóvel do Spring Boot.
                    const response = await fetch(`${API_BASE_URL}/properties/${propertyId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        }
                    });

                    // Comentário: Verifica a resposta e trata erros.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Imóvel não encontrado.');
                    }

                    const property = await response.json(); // Converte a resposta JSON para um objeto JavaScript.

                    // Comentário: Atualiza o título e descrição do formulário para modo de edição.
                    propertyFormTitle.textContent = 'Editar Imóvel';
                    propertyFormDescription.textContent = 'Modifique os campos abaixo para atualizar os dados do imóvel.';
                    propertyIdInput.value = property.id; // Define o ID do imóvel no campo hidden.

                    // Comentário: Preenche os campos gerais do imóvel.
                    document.getElementById('numero_matricula_imovel').value = property.numeroMatriculaImovel || '';
                    document.getElementById('finalidade').value = property.finalidade || '';
                    document.getElementById('valor').value = property.valor || '';
                    document.getElementById('area_total').value = property.areaTotal || '';
                    document.getElementById('status').value = property.status || '';
                    document.getElementById('data_cadastro_imovel').value = property.dataCadastro || '';
                    document.getElementById('data_atualizacao_imovel').value = property.dataAtualizacao || '';
                    // Comentário: Assume que 'proprietario' é um objeto aninhado no backend com 'id'.
                    document.getElementById('proprietario_imovel_select').value = property.proprietario?.id || ''; 
                    
                    // Comentário: Preenche os campos de endereço.
                    document.getElementById('cep_imovel').value = property.endereco?.cep || '';
                    document.getElementById('logradouro_imovel').value = property.endereco?.logradouro || '';
                    document.getElementById('numero_imovel').value = property.endereco?.numero || '';
                    document.getElementById('complemento_imovel').value = property.endereco?.complemento || '';
                    document.getElementById('bairro_imovel').value = property.endereco?.bairro || '';
                    document.getElementById('cidade_imovel').value = property.endereco?.cidade || '';
                    document.getElementById('estado_imovel').value = property.endereco?.estado || '';

                    // Comentário: Preenche os campos específicos do tipo de imóvel e dispara a visibilidade.
                    tipoImovelSelect.value = property.tipoImovel || '';
                    tipoImovelSelect.dispatchEvent(new Event('change')); // Força a atualização da visibilidade dos campos específicos.
                    
                    // Comentário: Popula os campos específicos com base no tipo de imóvel (sem precisar de 'if/else if' aqui, pois a função 'updatePropertyFieldsVisibility' já faz o show/hide).
                    if (property.tipoImovel === 'TERRENO') {
                        document.getElementById('topografia').value = property.topografia || '';
                        document.getElementById('tipo_solo').value = property.tipoSolo || '';
                    } else if (['CASA', 'APARTAMENTO'].includes(property.tipoImovel)) { // Agrupado para unidade residencial
                        document.getElementById('numero_quartos').value = property.numeroQuartos || '';
                        document.getElementById('numero_banheiros').value = property.numeroBanheiros || '';
                        document.getElementById('numero_suites').value = property.numeroSuites || '';
                        document.getElementById('area_construida').value = property.areaConstruida || '';
                        document.getElementById('numero_vagas_garagem').value = property.numeroVagasGaragem || '';
                        document.getElementById('descricao_residencial').value = property.descricaoResidencial || '';
                        if (property.tipoImovel === 'CASA') {
                            document.getElementById('possui_quintal').checked = property.possuiQuintal || false;
                            document.getElementById('numero_pavimentos').value = property.numeroPavimentos || '';
                        } else if (property.tipoImovel === 'APARTAMENTO') {
                            document.getElementById('andar').value = property.andar || '';
                            document.getElementById('numero_apartamento').value = property.numeroApartamento || '';
                            document.getElementById('possui_elevador').checked = property.possuiElevador || false;
                        }
                    } else if (['PREDIO_COMERCIAL', 'SALA_COMERCIAL'].includes(property.tipoImovel)) { // Agrupado para unidade comercial
                        document.getElementById('area_util').value = property.areaUtil || '';
                        document.getElementById('descricao_comercial').value = property.descricaoComercial || '';
                        if (property.tipoImovel === 'PREDIO_COMERCIAL') {
                            document.getElementById('total_andares').value = property.totalAndares || '';
                            document.getElementById('numero_salas').value = property.numeroSalas || '';
                            document.getElementById('possui_estacionamento').checked = property.possuiEstacionamento || false;
                        } else if (property.tipoImovel === 'SALA_COMERCIAL') {
                            document.getElementById('andar_sala').value = property.andarSala || '';
                            document.getElementById('numero_sala').value = property.numeroSala || '';
                        }
                    }

                    // Comentário: Torna o botão de exclusão visível e atribui a ele a função 'deleteProperty'.
                    deletePropertyBtn.style.display = 'inline-block';
                    deletePropertyBtn.onclick = () => deleteProperty(property.id);

                    showSection('register-property-section'); // Exibe a seção do formulário.

                } catch (error) {
                    console.error('Erro ao carregar imóvel para edição:', error);
                    alert(`Erro ao carregar imóvel: ${error.message}`);
                }
            };

            const resetPropertyForm = () => {
                propertyFormTitle.textContent = 'Cadastrar Novo Imóvel';
                propertyFormDescription.textContent = 'Preencha os campos abaixo para registrar um novo imóvel no sistema.';
                propertyIdInput.value = '';
                propertyRegistrationForm.reset();
                updatePropertyFieldsVisibility(); // Reset specific fields visibility
                deletePropertyBtn.style.display = 'none';
            };

// Comentário: Event listener para a submissão do formulário de cadastro/edição de imóvel.
            propertyRegistrationForm.addEventListener('submit', async (event) => { // Adicionado 'async'
                event.preventDefault();
                const formData = new FormData(propertyRegistrationForm);
                const propertyData = Object.fromEntries(formData.entries()); // Converte os dados do formulário em um objeto JavaScript.

                // Comentário: Coletar dados dos checkboxes e converter para booleanos.
                propertyData.possuiQuintal = propertyData.possuiQuintal === 'on';
                propertyData.possuiElevador = propertyData.possuiElevador === 'on';
                propertyData.possuiEstacionamento = propertyData.possuiEstacionamento === 'on';

                // Comentário: Reorganiza os dados para corresponder à estrutura de um DTO de imóvel no Spring.
                const propertyToSend = {
                    id: propertyData.propertyId || null,
                    numeroMatriculaImovel: propertyData.numeroMatriculaImovel,
                    finalidade: propertyData.finalidade,
                    valor: parseFloat(propertyData.valor),
                    areaTotal: parseFloat(propertyData.areaTotal),
                    status: propertyData.status,
                    dataCadastro: propertyData.dataCadastro,
                    dataAtualizacao: propertyData.dataAtualizacao || null, // Pode ser nulo
                    // Comentário: 'proprietario' deve ser um objeto com o ID, ou um DTO simplificado, dependendo do seu backend.
                    proprietario: { id: propertyData.proprietarioImovel }, 
                    endereco: { // Endereço como um objeto aninhado
                        cep: propertyData.cep,
                        logradouro: propertyData.logradouro,
                        numero: propertyData.numero,
                        complemento: propertyData.complemento,
                        bairro: propertyData.bairro,
                        cidade: propertyData.cidade,
                        estado: propertyData.estado
                    },
                    tipoImovel: propertyData.tipoImovel,
                    // Comentário: Campos específicos do tipo de imóvel, enviados apenas se o tipo for o correspondente.
                    // Comentário: O backend pode ignorar campos extras ou você pode construir o objeto de forma mais dinâmica.
                    topografia: propertyData.topografia || null,
                    tipoSolo: propertyData.tipoSolo || null,
                    numeroQuartos: parseInt(propertyData.numeroQuartos) || null,
                    numeroBanheiros: parseInt(propertyData.numeroBanheiros) || null,
                    numeroSuites: parseInt(propertyData.numeroSuites) || null,
                    areaConstruida: parseFloat(propertyData.areaConstruida) || null,
                    numeroVagasGaragem: parseInt(propertyData.numeroVagasGaragem) || null,
                    descricaoResidencial: propertyData.descricaoResidencial || null,
                    possuiQuintal: propertyData.possuiQuintal,
                    numeroPavimentos: parseInt(propertyData.numeroPavimentos) || null,
                    andar: parseInt(propertyData.andar) || null,
                    numeroApartamento: propertyData.numeroApartamento || null,
                    possuiElevador: propertyData.possuiElevador,
                    areaUtil: parseFloat(propertyData.areaUtil) || null,
                    descricaoComercial: propertyData.descricaoComercial || null,
                    totalAndares: parseInt(propertyData.totalAndares) || null,
                    numeroSalas: parseInt(propertyData.numeroSalas) || null,
                    possuiEstacionamento: propertyData.possuiEstacionamento,
                    andarSala: parseInt(propertyData.andarSala) || null,
                    numeroSala: propertyData.numeroSala || null
                };

                // Comentário: Determina o método HTTP (POST para novo, PUT para edição) e a URL do endpoint.
                const isEditing = !!propertyIdInput.value;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${API_BASE_URL}/properties/${propertyIdInput.value}` : `${API_BASE_URL}/properties`;

                try {
                    // Comentário: Envia os dados do imóvel para o backend.
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        },
                        body: JSON.stringify(propertyToSend) // Converte o objeto imóvel para JSON.
                    });

                    // Comentário: Verifica se a operação no backend foi bem-sucedida.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} imóvel.`);
                    }

                    // Comentário: Mensagem de sucesso e redirecionamento.
                    alert(`Imóvel ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
                    resetPropertyForm();
                    showSection('list-manage-properties-content');
                } catch (error) {
                    console.error(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} imóvel:`, error);
                    alert(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} imóvel: ${error.message}`);
                }
            });

// Comentário: Função assíncrona para excluir um imóvel do backend.
            const deleteProperty = async (propertyId) => { // Adicionado 'async'
                if (confirm('Tem certeza que deseja excluir este imóvel? Esta ação é irreversível.')) {
                    try {
                        // Comentário: Envia uma requisição DELETE para o endpoint de exclusão de imóvel do Spring Boot.
                        const response = await fetch(`${API_BASE_URL}/properties/${propertyId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                            }
                        });

                        // Comentário: Verifica se a exclusão foi bem-sucedida.
                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) {
                                alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                                removeToken();
                                window.location.href = 'login.html';
                                return;
                            }
                            const errorData = response.status !== 204 ? await response.json() : { message: 'Erro desconhecido.' };
                            throw new Error(errorData.message || 'Erro ao excluir imóvel.');
                        }

                        // Comentário: Mensagem de sucesso e recarregamento da lista de imóveis.
                        alert('Imóvel excluído com sucesso!');
                        resetPropertyForm();
                        showSection('list-manage-properties-content');
                    } catch (error) {
                        console.error('Erro ao excluir imóvel:', error);
                        alert(`Erro ao excluir imóvel: ${error.message}`);
                    }
                }
            };

            // VISIT AND INTEREST FUNCTIONS -----------------------------------------------------------


            // Event listener for property select change to update interest fields
            if (imovelVisitaSelect) {
                imovelVisitaSelect.addEventListener('change', updateAvaliacaoFieldsVisibility);
            }

            // Comentário: Função assíncrona para carregar e exibir as visitas na tabela a partir do backend.
            const loadVisitsTable = async (searchTerm = '') => { // Adicionado 'async'
                visitsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Carregando visitas...</td></tr>';

                try {
                    // Comentário: Faz uma requisição GET para o endpoint de listagem de visitas do Spring Boot.
                    // Comentário: O termo de pesquisa é enviado como um parâmetro de query string. O backend deve filtrar por cliente, imóvel, corretor, etc.
                    const response = await fetch(`${API_BASE_URL}/visits?search=${encodeURIComponent(searchTerm)}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao carregar visitas.');
                    }

                    const visits = await response.json(); // Converte a resposta JSON para um array de objetos JavaScript.

                    visitsTableBody.innerHTML = '';

                    if (visits.length === 0) {
                        visitsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-secondary);">Nenhuma visita encontrada.</td></tr>';
                        return;
                    }

                    visits.forEach(visit => {
                        // Comentário: Assume que o objeto 'visit' vindo do backend já inclui informações aninhadas de cliente, imóvel e corretor.
                        const clientName = visit.cliente?.nome || 'N/A';
                        const propertyAddress = visit.imovel ? `${visit.imovel.logradouro || ''}, ${visit.imovel.numero || ''}` : 'N/A';
                        const propertyMatricula = visit.imovel?.numeroMatriculaImovel || 'N/A';
                        const corretorName = visit.corretor?.nome || 'N/A';
                        const formattedDateTime = visit.dataHora ? new Date(visit.dataHora).toLocaleString('pt-BR') : 'N/A';

                        const row = visitsTableBody.insertRow();
                        row.innerHTML = `
                            <td data-label="Cliente">${clientName}</td>
                            <td data-label="Imóvel">${propertyAddress} (Mat. ${propertyMatricula})</td>
                            <td data-label="Corretor">${corretorName}</td>
                            <td data-label="Data/Hora">${formattedDateTime}</td>
                            <td data-label="Observações">${visit.observacoes || 'Nenhuma'}</td>
                            <td data-label="Ações" class="actions-cell">
                                <button class="edit-btn" data-visit-id="${visit.id}"><i class="fas fa-edit"></i></button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('#visits-table-body .edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const visitId = event.currentTarget.dataset.visitId;
                            editVisit(visitId);
                        });
                    });

                } catch (error) {
                    console.error('Erro ao buscar visitas:', error);
                    visitsTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--color-error);">Erro ao carregar visitas: ${error.message}</td></tr>`;
                }
            };

            if (visitSearchInput) {
                visitSearchInput.addEventListener('keyup', (event) => {
                    loadVisitsTable(event.target.value);
                });
            }



// Comentário: Função assíncrona para carregar os dados de uma visita específica para edição.
            const editVisit = async (visitId) => { // Adicionado 'async'
                try {
                    // Comentário: Faz uma requisição GET para o endpoint de detalhe de visita do Spring Boot.
                    const response = await fetch(`${API_BASE_URL}/visits/${visitId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        }
                    });

                    // Comentário: Verifica a resposta e trata erros.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Visita não encontrada.');
                    }

                    const visit = await response.json(); // Converte a resposta JSON para um objeto JavaScript.

                    // Comentário: Atualiza o título e descrição do formulário.
                    visitFormTitle.textContent = 'Editar Visita e Interesse';
                    visitFormDescription.textContent = 'Modifique os campos abaixo para atualizar o registro da visita e seus interesses.';
                    visitIdInput.value = visit.id; // Define o ID da visita no campo hidden.

                    await populateVisitFormSelects(); // Popula os selects assincronamente antes de definir os valores.
                    // Comentário: Preenche os selects com os IDs do objeto 'visit' recebido.
                    clienteVisitaSelect.value = visit.cliente?.id || '';
                    imovelVisitaSelect.value = visit.imovel?.id || '';
                    corretorVisitaSelect.value = visit.corretor?.id || '';
                    document.getElementById('data_hora_visita').value = visit.dataHora || '';
                    document.getElementById('observacoes_visita').value = visit.observacoes || '';

                    // Comentário: Dispara change no select de imóvel para atualizar campos de avaliação.
                    // Comentário: Usar setTimeout para garantir que as opções do select sejam renderizadas antes do dispatch.
                    setTimeout(() => {
                        imovelVisitaSelect.dispatchEvent(new Event('change'));
                        // Comentário: Popula as avaliações de interesse após os campos estarem visíveis.
                        if (visit.interesses) {
                            for (const key in visit.interesses) {
                                if (visit.interesses.hasOwnProperty(key)) {
                                    const ratingValue = visit.interesses[key];
                                    const radioInput = document.querySelector(`input[name="avaliacao_${key}"][value="${ratingValue}"]`);
                                    if (radioInput) {
                                        radioInput.checked = true;
                                    }
                                }
                            }
                        }
                    }, 0);

                    // Comentário: Torna o botão de exclusão visível e atribui a ele a função 'deleteVisit'.
                    deleteVisitBtn.style.display = 'inline-block';
                    deleteVisitBtn.onclick = () => deleteVisit(visit.id);

                    showSection('register-visit-interest-section'); // Exibe a seção do formulário.

                } catch (error) {
                    console.error('Erro ao carregar visita para edição:', error);
                    alert(`Erro ao carregar visita: ${error.message}`);
                }
            };

            const resetVisitForm = () => {
                visitFormTitle.textContent = 'Registrar Visita e Interesse';
                visitFormDescription.textContent = 'Preencha os campos abaixo para registrar uma nova visita e a avaliação de interesse.';
                visitIdInput.value = '';
                visitRegistrationForm.reset();
                populateVisitFormSelects(); // Reset selects
                updateAvaliacaoFieldsVisibility(); // Hide/reset interest fields
                deleteVisitBtn.style.display = 'none';
            };

// Comentário: Event listener para a submissão do formulário de cadastro/edição de visita.
            visitRegistrationForm.addEventListener('submit', async (event) => { // Adicionado 'async'
                event.preventDefault();

                const formData = new FormData(visitRegistrationForm);
                const visitData = Object.fromEntries(formData.entries()); // Converte os dados do formulário em um objeto JavaScript.

                // Comentário: Coleta os interesses avaliados dinamicamente a partir dos campos de rádio.
                const interesses = {};
                avaliacaoFields.querySelectorAll('.form-group[data-interest-field]').forEach(group => {
                    const fieldName = group.dataset.interestField;
                    const checkedRadio = group.querySelector(`input[name="avaliacao_${fieldName}"]:checked`);
                    if (checkedRadio) {
                        interesses[fieldName] = parseInt(checkedRadio.value);
                    }
                });

                // Comentário: Reorganiza os dados para corresponder à estrutura de um DTO de visita no Spring.
                const visitToSend = {
                    id: visitData.visitId || null,
                    // Comentário: Envia apenas o ID do cliente, imóvel e corretor.
                    cliente: { id: visitData.clienteVisita }, 
                    imovel: { id: visitData.imovelVisita },
                    corretor: { id: visitData.corretorVisita },
                    dataHora: visitData.dataHora,
                    observacoes: visitData.observacoes,
                    interesses: interesses // Inclui o objeto de interesses.
                };

                // Comentário: Determina o método HTTP (POST para novo, PUT para edição) e a URL do endpoint.
                const isEditing = !!visitIdInput.value;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${API_BASE_URL}/visits/${visitIdInput.value}` : `${API_BASE_URL}/visits`;

                try {
                    // Comentário: Envia os dados da visita para o backend.
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        },
                        body: JSON.stringify(visitToSend) // Converte o objeto visita para JSON.
                    });

                    // Comentário: Verifica se a operação no backend foi bem-sucedida.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} visita.`);
                    }

                    // Comentário: Mensagem de sucesso e redirecionamento.
                    alert(`Visita ${isEditing ? 'atualizada' : 'cadastrada'} com sucesso!`);
                    resetVisitForm();
                    showSection('consult-visits-section');
                } catch (error) {
                    console.error(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} visita:`, error);
                    alert(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} visita: ${error.message}`);
                }
            });

// Comentário: Função assíncrona para excluir uma visita do backend.
            const deleteVisit = async (visitId) => { // Adicionado 'async'
                if (confirm('Tem certeza que deseja excluir esta visita? Esta ação é irreversível.')) {
                    try {
                        // Comentário: Envia uma requisição DELETE para o endpoint de exclusão de visita do Spring Boot.
                        const response = await fetch(`${API_BASE_URL}/visits/${visitId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                            }
                        });

                        // Comentário: Verifica se a exclusão foi bem-sucedida.
                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) {
                                alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                                removeToken();
                                window.location.href = 'login.html';
                                return;
                            }
                            const errorData = response.status !== 204 ? await response.json() : { message: 'Erro desconhecido.' };
                            throw new Error(errorData.message || 'Erro ao excluir visita.');
                        }

                        // Comentário: Mensagem de sucesso e recarregamento da lista de visitas.
                        alert('Visita excluída com sucesso!');
                        resetVisitForm();
                        showSection('consult-visits-section');
                    } catch (error) {
                        console.error('Erro ao excluir visita:', error);
                        alert(`Erro ao excluir visita: ${error.message}`);
                    }
                }
            };

            // PROPERTY SUGGESTIONS FUNCTIONS -----------------------------------------------------------

// Comentário: Função assíncrona para carregar e exibir os clientes na tabela de seleção para sugestão de imóveis.
            const loadClientsForSuggestionsTable = async (searchTerm = '') => { // Adicionado 'async'
                clientsForSuggestionTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Carregando clientes...</td></tr>';

                try {
                    // Comentário: Faz uma requisição GET para o endpoint de listagem de clientes.
                    // Comentário: O backend deve retornar uma lista de clientes filtrada pelo termo de busca.
                    const response = await fetch(`${API_BASE_URL}/clients?search=${encodeURIComponent(searchTerm)}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao carregar clientes para sugestão.');
                    }

                    const clients = await response.json(); // Converte a resposta JSON para um array de objetos JavaScript.

                    clientsForSuggestionTableBody.innerHTML = '';

                    if (clients.length === 0) {
                        clientsForSuggestionTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--color-secondary);">Nenhum cliente encontrado.</td></tr>';
                        return;
                    }

                    clients.forEach(client => {
                        const row = clientsForSuggestionTableBody.insertRow();
                        const primaryKeyValue = client.documentType === 'CPF' ? client.cpf : client.cnpj;
                        row.innerHTML = `
                            <td data-label="Nome">${client.nome}</td>
                            <td data-label="Chave Primária">${primaryKeyValue || 'N/A'}</td>
                            <td data-label="Ações" class="actions-cell">
                                <button class="select-client-btn btn btn-primary" data-client-id="${client.id}" data-client-name="${client.nome}"><i class="fas fa-check"></i> Selecionar</button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('#clients-for-suggestion-table-body .select-client-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const clientId = event.currentTarget.dataset.clientId;
                            const clientName = event.currentTarget.dataset.clientName; // Obtém o nome do cliente do data attribute
                            selectedClientNameForSuggestions.textContent = clientName;
                            loadPropertySuggestions(clientId); // Chama a função para carregar sugestões com o ID do cliente.
                        });
                    });

                } catch (error) {
                    console.error('Erro ao buscar clientes para sugestão:', error);
                    clientsForSuggestionTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--color-error);">Erro ao carregar clientes: ${error.message}</td></tr>`;
                }
            };

            if (clientSuggestionSearchInput) {
                clientSuggestionSearchInput.addEventListener('keyup', (event) => {
                    loadClientsForSuggestionsTable(event.target.value);
                });
            }


            // Comentário: Função assíncrona para carregar sugestões de imóveis para um cliente específico do backend.
            const loadPropertySuggestions = async (clientId) => { // Adicionado 'async'
                suggestedPropertiesGallery.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Carregando sugestões de imóveis...</p>';

                if (!clientId) {
                    suggestedPropertiesGallery.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--color-secondary);">Selecione um cliente acima para ver as sugestões de imóveis.</p>';
                    selectedClientNameForSuggestions.textContent = '';
                    return;
                }

                // Comentário: Não precisamos buscar o cliente aqui, pois o nome já foi passado via data-attribute no loadClientsForSuggestionsTable.
                // Comentário: A lógica de compatibilidade e ordenação é totalmente transferida para o backend.

                try {
                    // Comentário: Faz uma requisição GET para o endpoint de sugestões de imóveis no Spring Boot.
                    // Comentário: Assume-se que o backend receberá o clientId e usará sua lógica interna (interesses do cliente, características dos imóveis)
                    // Comentário: para calcular e retornar uma lista de imóveis já ordenados por compatibilidade,
                    // Comentário: e que cada imóvel retornado terá um array 'topAttributes' com nome do atributo e pontuação de interesse/compatibilidade.
                    const response = await fetch(`${API_BASE_URL}/clients/${clientId}/suggested-properties`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao carregar sugestões de imóveis.');
                    }

                    // Comentário: O backend DEVE retornar uma lista de objetos de imóvel, cada um com uma propriedade 'topAttributes'
                    // Comentário: que é um array de { name: 'nomeDoAtributo', score: 4 }
                    const suggestedProperties = await response.json();

                    suggestedPropertiesGallery.innerHTML = '';

                    if (suggestedProperties.length === 0) {
                        suggestedPropertiesGallery.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--color-secondary);">Nenhum imóvel sugerido encontrado para este cliente.</p>';
                        return;
                    }

                    suggestedProperties.forEach(property => {
                        const propertyCard = document.createElement('a');
                        propertyCard.href = `#register-property-section`; // Link para a seção de edição do imóvel
                        propertyCard.classList.add('stat-card', 'action-card');
                        propertyCard.dataset.propertyId = property.id; // Armazena o ID do imóvel

                        const propertyTitle = document.createElement('h3');
                        propertyTitle.textContent = property.numeroMatriculaImovel || 'Imóvel sem Matrícula';
                        propertyCard.appendChild(propertyTitle);

                        const propertyAddress = document.createElement('p');
                        propertyAddress.textContent = `${property.endereco?.logradouro || ''}, ${property.endereco?.numero || ''} - ${property.endereco?.bairro || ''}`; // Assume endereco aninhado
                        propertyCard.appendChild(propertyAddress);

                        const compatibilityList = document.createElement('ul');
                        compatibilityList.style.listStyle = 'none';
                        compatibilityList.style.padding = '0';
                        compatibilityList.style.marginTop = '10px';

                        // Comentário: Agora, itera sobre 'topAttributes' que veio *do backend*.
                        const topAttributes = property.topAttributes || [];

                        if (topAttributes.length > 0) {
                            topAttributes.forEach(attr => {
                                const listItem = document.createElement('li');
                                listItem.style.display = 'flex';
                                listItem.style.justifyContent = 'space-between';
                                listItem.style.alignItems = 'center';
                                listItem.style.marginBottom = '5px';
                                // Comentário: Usa 'translateFieldName' para nomes amigáveis e 'generateStarRating' para estrelas.
                                listItem.innerHTML = `<span>${translateFieldName(attr.name)}:</span> ${generateStarRating(attr.score)}`;
                                compatibilityList.appendChild(listItem);
                            });
                        } else {
                            const noData = document.createElement('p');
                            noData.textContent = 'Sem dados de compatibilidade disponíveis.';
                            noData.style.fontSize = '14px';
                            noData.style.color = 'var(--color-secondary)';
                            compatibilityList.appendChild(noData);
                        }

                        propertyCard.appendChild(compatibilityList);
                        suggestedPropertiesGallery.appendChild(propertyCard);
                    });

                    document.querySelectorAll('#suggested-properties-gallery .action-card').forEach(card => {
                        card.addEventListener('click', (event) => {
                            event.preventDefault();
                            const propertyId = event.currentTarget.dataset.propertyId;
                            editProperty(propertyId);
                        });
                    });

                } catch (error) {
                    console.error('Erro ao buscar sugestões de imóveis:', error);
                    suggestedPropertiesGallery.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--color-error);">Erro ao carregar sugestões: ${error.message}</p>`;
                }
            };

            // SALES FUNCTIONS -----------------------------------------------------------


            
// Comentário: Função assíncrona para carregar e exibir as vendas na tabela a partir do backend.
            const loadSalesTable = async (searchTerm = '') => { // Adicionado 'async'
                salesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Carregando vendas...</td></tr>';

                try {
                    // Comentário: Faz uma requisição GET para o endpoint de listagem de vendas do Spring Boot.
                    // Comentário: O termo de pesquisa é enviado como um parâmetro de query string. O backend deve filtrar por imóvel, comprador, proprietário, corretor, etc.
                    const response = await fetch(`${API_BASE_URL}/sales?search=${encodeURIComponent(searchTerm)}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao carregar vendas.');
                    }

                    const sales = await response.json(); // Converte a resposta JSON para um array de objetos JavaScript.

                    salesTableBody.innerHTML = '';

                    if (sales.length === 0) {
                        salesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-secondary);">Nenhuma venda registrada.</td></tr>';
                        return;
                    }

                    sales.forEach(sale => {
                        // Comentário: Assume que o objeto 'sale' vindo do backend já inclui informações aninhadas de imóvel, comprador, proprietário e corretor.
                        const propertyInfo = sale.imovel ? `${sale.imovel.numeroMatriculaImovel || 'N/A'} (${sale.imovel.logradouro || ''}, ${sale.imovel.numero || ''})` : 'N/A';
                        const compradorName = sale.comprador?.nome || 'N/A';
                        const proprietarioName = sale.proprietario?.nome || 'N/A';
                        const corretorName = sale.corretor?.nome || 'N/A';
                        const formattedDate = sale.dataVenda ? new Date(sale.dataVenda).toLocaleString('pt-BR') : 'N/A';
                        const formattedValor = sale.valorFinal ? `R$ ${sale.valorFinal.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}` : 'R$ 0,00';

                        const row = salesTableBody.insertRow();
                        row.innerHTML = `
                            <td data-label="Imóvel">${propertyInfo}</td>
                            <td data-label="Comprador">${compradorName}</td>
                            <td data-label="Proprietário">${proprietarioName}</td>
                            <td data-label="Corretor">${corretorName}</td>
                            <td data-label="Data da Venda">${formattedDate}</td>
                            <td data-label="Valor Final">${formattedValor}</td>
                            <td data-label="Ações" class="actions-cell">
                                <button class="edit-btn" data-sale-id="${sale.id}"><i class="fas fa-edit"></i></button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('#sales-table-body .edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const saleId = event.currentTarget.dataset.saleId;
                            editSale(saleId);
                        });
                    });

                } catch (error) {
                    console.error('Erro ao buscar vendas:', error);
                    salesTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--color-error);">Erro ao carregar vendas: ${error.message}</td></tr>`;
                }
            };

            if (saleSearchInput) {
                saleSearchInput.addEventListener('keyup', (event) => {
                    loadSalesTable(event.target.value);
                });
            }

// Comentário: Função assíncrona para carregar os dados de uma venda específica para edição.
            const editSale = async (saleId) => { // Adicionado 'async'
                try {
                    // Comentário: Faz uma requisição GET para o endpoint de detalhe de venda do Spring Boot.
                    const response = await fetch(`${API_BASE_URL}/sales/${saleId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        }
                    });

                    // Comentário: Verifica a resposta e trata erros.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Venda não encontrada.');
                    }

                    const sale = await response.json(); // Converte a resposta JSON para um objeto JavaScript.

                    // Comentário: Atualiza o título e descrição do formulário.
                    saleFormTitle.textContent = 'Editar Venda';
                    saleFormDescription.textContent = 'Modifique os campos abaixo para atualizar o registro da venda.';
                    saleIdInput.value = sale.id; // Define o ID da venda no campo hidden.

                    await populateSaleFormSelects(); // Popula os selects assincronamente antes de definir os valores.

                    // Comentário: Preenche os selects e campos com os IDs/valores do objeto 'sale' recebido.
                    imovelVendaSelect.value = sale.imovel?.id || '';
                    // Comentário: Dispara change no select de imóvel para automaticamente definir o proprietário.
                    imovelVendaSelect.dispatchEvent(new Event('change')); 
                    
                    clienteCompradorSelect.value = sale.comprador?.id || '';
                    corretorVendaSelect.value = sale.corretor?.id || '';
                    document.getElementById('data_venda').value = sale.dataVenda || '';
                    document.getElementById('valor_final').value = sale.valorFinal || '';
                    
                    // Comentário: Proprietário já deve ter sido preenchido automaticamente pelo change do imóvel.

                    // Comentário: Torna o botão de exclusão visível e atribui a ele a função 'deleteSale'.
                    deleteSaleBtn.style.display = 'inline-block';
                    deleteSaleBtn.onclick = () => deleteSale(sale.id);

                    showSection('register-sale-section'); // Exibe a seção do formulário.

                } catch (error) {
                    console.error('Erro ao carregar venda para edição:', error);
                    alert('Venda não encontrada para edição.');
                }
            };

            const resetSaleForm = () => {
                saleFormTitle.textContent = 'Registrar Nova Venda';
                saleFormDescription.textContent = 'Preencha os campos abaixo para registrar uma nova venda no sistema.';
                saleIdInput.value = '';
                saleRegistrationForm.reset();
                populateSaleFormSelects(); // Reset selects
                deleteSaleBtn.style.display = 'none';
            };

// Comentário: Event listener para a submissão do formulário de cadastro/edição de venda.
            saleRegistrationForm.addEventListener('submit', async (event) => { // Adicionado 'async'
                event.preventDefault();

                const formData = new FormData(saleRegistrationForm);
                const saleData = Object.fromEntries(formData.entries()); // Converte os dados do formulário em um objeto JavaScript.

                // Comentário: Reorganiza os dados para corresponder à estrutura de um DTO de venda no Spring.
                const saleToSend = {
                    id: saleData.saleId || null,
                    // Comentário: Envia apenas o ID do imóvel, comprador, proprietário e corretor.
                    imovel: { id: saleData.numeroMatriculaImovel }, 
                    comprador: { id: saleData.cpfCnpjClienteComprador },
                    proprietario: { id: saleData.cpfCnpjProprietarioImovel }, // Proprietário vem do select desabilitado
                    corretor: { id: saleData.cpfCnpjCorretor },
                    dataVenda: saleData.dataVenda,
                    valorFinal: parseFloat(saleData.valorFinal)
                };

                // Comentário: Determina o método HTTP (POST para novo, PUT para edição) e a URL do endpoint.
                const isEditing = !!saleIdInput.value;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${API_BASE_URL}/sales/${saleIdInput.value}` : `${API_BASE_URL}/sales`;

                try {
                    // Comentário: Envia os dados da venda para o backend.
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                        },
                        body: JSON.stringify(saleToSend) // Converte o objeto venda para JSON.
                    });

                    // Comentário: Verifica se a operação no backend foi bem-sucedida.
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                            removeToken();
                            window.location.href = 'login.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} venda.`);
                    }

                    // Comentário: Mensagem de sucesso e redirecionamento.
                    alert(`Venda ${isEditing ? 'atualizada' : 'cadastrada'} com sucesso!`);
                    resetSaleForm();
                    showSection('track-sales-section');
                } catch (error) {
                    console.error(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} venda:`, error);
                    alert(`Erro ao ${isEditing ? 'atualizar' : 'cadastrar'} venda: ${error.message}`);
                }
            });

// Comentário: Função assíncrona para excluir uma venda do backend.
            const deleteSale = async (saleId) => { // Adicionado 'async'
                if (confirm('Tem certeza que deseja excluir esta venda? Esta ação é irreversível.')) {
                    try {
                        // Comentário: Envia uma requisição DELETE para o endpoint de exclusão de venda do Spring Boot.
                        const response = await fetch(`${API_BASE_URL}/sales/${saleId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${getToken()}` // Envia o token JWT
                            }
                        });

                        // Comentário: Verifica se a exclusão foi bem-sucedida.
                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) {
                                alert('Sessão expirada ou não autorizado. Por favor, faça login novamente.');
                                removeToken();
                                window.location.href = 'login.html';
                                return;
                            }
                            const errorData = response.status !== 204 ? await response.json() : { message: 'Erro desconhecido.' };
                            throw new Error(errorData.message || 'Erro ao excluir venda.');
                        }

                        // Comentário: Mensagem de sucesso e recarregamento da lista de vendas.
                        alert('Venda excluída com sucesso!');
                        resetSaleForm();
                        showSection('track-sales-section');
                    } catch (error) {
                        console.error('Erro ao excluir venda:', error);
                        alert(`Erro ao excluir venda: ${error.message}`);
                    }
                }
            };


            // COMMON FUNCTIONS (between User, Client, Property, etc.) -------------------
            // Lógica para mostrar/ocultar campos CPF/CNPJ para USUÁRIO
            const cpfCnpjSelectUser = document.getElementById('cpf_cnpj_select_user');
            const cpfGroupUser = document.getElementById('cpf_group_user');
            const cnpjGroupUser = document.getElementById('cnpj_group_user');
            const cpfInputUser = document.getElementById('cpf_user');
            const cnpjInputUser = document.getElementById('cnpj_user');

            const toggleCpfCnpjUserFields = () => {
                if (cpfCnpjSelectUser && cpfCnpjSelectUser.value === 'CPF') {
                    cpfGroupUser.style.display = 'block';
                    cnpjGroupUser.style.display = 'none';
                    cpfInputUser.setAttribute('required', 'true');
                    cnpjInputUser.removeAttribute('required');
                    cnpjInputUser.value = '';
                } else if (cpfCnpjSelectUser && cpfCnpjSelectUser.value === 'CNPJ') {
                    cpfGroupUser.style.display = 'none';
                    cnpjGroupUser.style.display = 'block';
                    cnpjInputUser.setAttribute('required', 'true');
                    cpfInputUser.removeAttribute('required');
                    cpfInputUser.value = '';
                } else {
                    cpfGroupUser.style.display = 'none';
                    cnpjGroupUser.style.display = 'none';
                    cpfInputUser.removeAttribute('required');
                    cnpjInputUser.removeAttribute('required');
                    cpfInputUser.value = '';
                    cnpjInputUser.value = '';
                }
            };
            if (cpfCnpjSelectUser) {
                cpfCnpjSelectUser.addEventListener('change', toggleCpfCnpjUserFields);
                toggleCpfCnpjUserFields(); // Initial call to set correct visibility
            }


            // Lógica para mostrar/ocultar Área de Atuação para Corretor
            const tipoCargoSelect = document.getElementById('tipo_cargo');
            const areaAtuacaoGroup = document.getElementById('area_atuacao_group');
            const areaAtuacaoInput = document.getElementById('area_atuacao');

            const toggleAreaAtuacao = () => {
                if (tipoCargoSelect && tipoCargoSelect.value === 'CORRETOR') {
                    areaAtuacaoGroup.style.display = 'block';
                    areaAtuacaoInput.setAttribute('required', 'true');
                } else {
                    areaAtuacaoGroup.style.display = 'none';
                    areaAtuacaoInput.removeAttribute('required');
                    areaAtuacaoInput.value = '';
                }
            };

            if (tipoCargoSelect) {
                tipoCargoSelect.addEventListener('change', toggleAreaAtuacao);
                toggleAreaAtuacao(); // Initial call
            }



            if (tipoImovelSelect) {
                tipoImovelSelect.addEventListener('change', updatePropertyFieldsVisibility);
                updatePropertyFieldsVisibility(); // Initial call
            }

            // Comentário: Lógica para mostrar a seção inicial (Dashboard) ou uma seção específica via hash.
            const initialHash = window.location.hash.substring(1); //
            if (initialHash && document.getElementById(initialHash)) { //
                showSection(initialHash); //
            } else {
                showSection('dashboard-section');
            } 
        });
    </script>
</body>
</html>